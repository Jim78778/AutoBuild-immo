name: Build Swaiot CPE-S10 ImmortalWrt (NSS Stable)

on:
  workflow_dispatch:
  push:
    branches:
      - patch-1

env:
  REPO_URL: https://github.com/Jim78778/immortalwrt-ipq.git
  REPO_BRANCH: Jim78778-patch-1
  CONFIG_FILE: ci.config
  TZ: Asia/Shanghai
  UPLOAD_FIRMWARE: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout CI Repo
      uses: actions/checkout@v4

    - name: Set Timezone
      run: sudo timedatectl set-timezone "$TZ"

    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt clean
        df -h

    - name: Install Build Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex g++ gawk gcc-multilib gettext \
          git libncurses5-dev libssl-dev python3 python3-distutils \
          rsync unzip zlib1g-dev file wget libelf-dev \
          bc subversion ecj fastjar

    - name: Clone ImmortalWrt Source
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt

    - name: Add QModem feed
      run: |
        cd openwrt
        echo "src-git qmodem https://github.com/FUjr/QModem.git" >> feeds.conf.default

    - name: Update & Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load Config (CPE-S10 only, no Rust)
      run: |
        cd openwrt

        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "❌ ci.config not found"
          exit 1
        fi

        cp $GITHUB_WORKSPACE/$CONFIG_FILE .config

        # 禁用 Rust（彻底）
        sed -i 's/^CONFIG_RUST.*$/# &/' .config
        sed -i 's/^CONFIG_RUST_TOOLCHAIN.*$/# &/' .config

        # 只保留 CPE-S10
        sed -i 's/^CONFIG_TARGET_qualcommax_ipq807x_DEVICE_.*/# &/' .config
        echo 'CONFIG_TARGET_qualcommax_ipq807x_DEVICE_cpe_s10=y' >> .config

        # 启用 NSS 核心驱动
        echo 'CONFIG_PACKAGE_kmod-qca-nss-drv=y' >> .config

        make defconfig

        echo "==== FINAL CONFIG CHECK ===="
        grep -i rust .config || echo "OK: rust disabled"
        grep CONFIG_TARGET_qualcommax_ipq807x_DEVICE_cpe_s10 .config
        grep CONFIG_PACKAGE_kmod-qca-nss-drv .config

    - name: Compile qca-nss-drv (SERIAL)
      run: |
        cd openwrt
        echo "▶ compiling qca-nss-drv (j1)"
        make package/feeds/nss_packages/qca-nss-drv/compile V=s -j1

        echo "▶ locating Module.symvers"
        NSS_SYMS=$(find build_dir/target-* \
          -path '*qca-nss-drv*' \
          -name Module.symvers | head -n1)

        if [ -z "$NSS_SYMS" ]; then
          echo "❌ NSS Module.symvers NOT FOUND"
          exit 1
        fi

        echo "✅ NSS Module.symvers = $NSS_SYMS"
        echo "NSS_SYMS=$NSS_SYMS" >> $GITHUB_ENV

    - name: Compile qca-nss-ecm (SERIAL, injected symbols)
      run: |
        cd openwrt
        echo "▶ compiling qca-nss-ecm (j1)"
        export KBUILD_EXTRA_SYMBOLS="$NSS_SYMS"
        make package/feeds/nss_packages/qca-nss-ecm/compile V=s -j1

        echo "▶ verifying ECM ipk"
        ECM_IPK=$(find bin/packages -name '*nss-ecm*.ipk' | wc -l)
        if [ "$ECM_IPK" -eq 0 ]; then
          echo "❌ ECM build failed: no ipk generated"
          exit 1
        fi
        echo "✅ ECM ipk generated"

    - name: Download Packages
      run: |
        cd openwrt
        make download -j$(nproc)

    - name: Compile Firmware
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s

    - name: Final NSS Sanity Check
      run: |
        cd openwrt
        for p in nss-drv nss-ecm; do
          find bin/packages -name "*$p*.ipk" | grep -q . || {
            echo "❌ missing $p ipk"
            exit 1
          }
        done
        echo "✅ NSS stack OK"

    - name: Upload Firmware
      if: success() && env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: Swaiot-CPE-S10-Firmware
        path: openwrt/bin/targets/ipq807x/*


name: Build Swaiot CPE-S10 ImmortalWrt

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # -------------------------------------------------
    # 0. 检查服务器配置
    # -------------------------------------------------
    - name: 检查服务器配置
      run: |
        echo "若分配的服务器性能不足，务必及时取消，重新运行！"
        echo -e "------------------------------- CPU信息 -------------------------------\n"
        echo "CPU物理数量: $(cat /proc/cpuinfo | grep 'physical id' | sort | uniq | wc -l)"
        echo -e "CPU核心及版本信息: $(cat /proc/cpuinfo | grep 'name' | cut -f2 -d: | uniq -c) \n"
        echo -e "------------------------------- 内存信息 -------------------------------\n"
        echo "已安装内存详细信息: "
        sudo lshw -short -C memory | grep GiB
        echo -e "\n"
        echo -e "------------------------------- 磁盘信息 -------------------------------\n"
        echo -e "磁盘数量: $(ls /dev/sd* | grep -v [1-9] | wc -l) \n"
        echo "------------------------------- 磁盘详情 -------------------------------\n"
        df -Th

    # -------------------------------------------------
    # 1. Checkout
    # -------------------------------------------------
    - name: Checkout
      run: |
        git clone --depth=1 -b Jim78778-patch-1 https://github.com/Jim78778/immortalwrt-ipq.git openwrt
        cd openwrt

    # -------------------------------------------------
    # 2. Install dependencies
    # -------------------------------------------------
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git gawk gcc g++ make cmake python3 python3-pip \
          unzip curl wget ccache clang lld llvm device-tree-compiler bison flex libncurses-dev \
          libssl-dev libelf-dev zlib1g-dev qemu-utils rsync squashfs-tools patch pkgconf \
          python3-docutils python3-pyelftools upx-ucl p7zip-full ninja-build msmtp nano vim jq
        sudo timedatectl set-timezone "$TZ"

    # -------------------------------------------------
    # 3. Add QModem feed
    # -------------------------------------------------
    - name: Add QModem feed
      run: |
        cd openwrt
        echo 'src-git qmodem https://github.com/FUjr/QModem.git;v2.8.0' >> feeds.conf.default
        tail -n 5 feeds.conf.default

    # -------------------------------------------------
    # 4. Update & install feeds
    # -------------------------------------------------
    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a -f -p qmodem
        ./scripts/feeds install -a

    # -------------------------------------------------
    # 5. DIY part 1 (可选)
    # -------------------------------------------------
    - name: DIY part 1
      run: |
        cd openwrt
        if [ -f ../diy-part1.sh ]; then
          chmod +x ../diy-part1.sh
          ../diy-part1.sh
        fi

    # -------------------------------------------------
    # 6. Apply ci.config
    # -------------------------------------------------
    - name: Apply ci.config
      run: |
        cd openwrt
        cp ../ci.config .config

    # -------------------------------------------------
    # 7. Force CPE-S10 target
    # -------------------------------------------------
    - name: Force CPE-S10 target
      run: |
        cd openwrt
        sed -i '/^CONFIG_TARGET_/d' .config
        cat >> .config << 'EOF'
        CONFIG_TARGET_qualcommax=y
        CONFIG_TARGET_qualcommax_ipq807x=y
        CONFIG_TARGET_qualcommax_ipq807x_DEVICE_swaiot_cpe_s10=y
        EOF
        grep CONFIG_TARGET_ .config

    # -------------------------------------------------
    # 8. Enable QModem & MHI
    # -------------------------------------------------
    - name: Enable QModem & MHI
      run: |
        cd openwrt
        cat >> .config << 'EOF'
        CONFIG_PACKAGE_qmodem=y
        CONFIG_PACKAGE_luci-app-qmodem=y
        CONFIG_PACKAGE_kmod-mhi-wwan-mbim=y
        CONFIG_PACKAGE_kmod-mhi-wwan-ctrl=y
        CONFIG_PACKAGE_kmod-mhi-pci-generic=y
        CONFIG_PACKAGE_kmod-pcie_mhi=y
        CONFIG_PCI=y
        CONFIG_PCIE_QCOM=y
        EOF

    # -------------------------------------------------
    # 9. Make defconfig
    # -------------------------------------------------
    - name: Make defconfig
      run: |
        cd openwrt
        make defconfig
        grep -E 'QMODEM|MHI|PCIE' .config || true

    # -------------------------------------------------
    # 10. Download packages
    # -------------------------------------------------
    - name: Download packages
      run: |
        cd openwrt
        make download -j$(nproc)

    # -------------------------------------------------
    # 11. Build firmware
    # -------------------------------------------------
    - name: Build firmware
      run: |
        cd openwrt
        make -j$(nproc) V=s

    # -------------------------------------------------
    # 12. Upload firmware
    # -------------------------------------------------
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: CPE-S10-firmware
        path: openwrt/bin/targets/
        retention-days: 30

name: Build CPE-S10 (MHI + QModem)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Prepare environment
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib gettext git libncurses-dev libssl-dev python3 \
          python3-distutils rsync unzip zlib1g-dev file wget

    - name: Clone ImmortalWrt
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt openwrt

    - name: Load custom config
      run: |
        cp ci.config openwrt/.config

    - name: Update & install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # ğŸ”´ å…³é”®ï¼šåœ¨ feeds install ä¹‹åå†åˆå¹¶é¢å¤– config
    - name: Merge device config
      run: |
        cd openwrt
        cat ../swaiot.config >> .config

    # ğŸ”´ æ˜ç¡®æ£€æŸ¥ kmod-mhi-wwan æ˜¯å¦å¯é€‰
    - name: Check MHI options
      run: |
        cd openwrt
        grep -R "kmod-mhi-wwan" package/feeds || true

    # ğŸ”´ ç”¨ defconfigï¼Œè€Œä¸æ˜¯ olddefconfig
    - name: Make defconfig
      run: |
        cd openwrt
        make defconfig

    - name: Download packages
      run: |
        cd openwrt
        make download -j8

    - name: Build firmware
      run: |
        cd openwrt
        make -j$(nproc) V=s

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: CPE-S10-firmware
        path: openwrt/bin/targets/

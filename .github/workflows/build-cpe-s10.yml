name: Build Swaiot CPE-S10 ImmortalWrt

on:
  workflow_dispatch:
  push:
    branches:
      - patch-1

env:
  REPO_URL: https://github.com/Jim78778/immortalwrt-ipq.git
  REPO_BRANCH: Jim78778-patch-1
  CONFIG_FILE: ci.config
  FEEDS_CONF: feeds.conf.default
  TZ: Asia/Shanghai
  UPLOAD_FIRMWARE: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout CI Repo
      uses: actions/checkout@v4

    - name: Set Timezone
      run: sudo timedatectl set-timezone "$TZ"

    - name: Free Disk Space (IMPORTANT)
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt clean
        df -h

    - name: Install Build Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex g++ gawk gcc-multilib gettext \
          git libncurses5-dev libssl-dev python3 python3-distutils \
          rsync unzip zlib1g-dev file wget \
          libelf-dev ecj fastjar

    - name: Clone ImmortalWrt Source
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt

    - name: Add QModem feed
      run: |
        cd openwrt
        echo "src-git qmodem https://github.com/FUjr/QModem.git" >> feeds.conf.default

    - name: Update & Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load CI Config (single device, rust killed)
      run: |
        cd openwrt

        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "âŒ ci.config not found"
          exit 1
        fi

        cp $GITHUB_WORKSPACE/$CONFIG_FILE .config

        # ðŸš« å¼ºåˆ¶ç¦ç”¨ Rustï¼ˆåŒä¿é™©ï¼‰
        sed -i 's/CONFIG_RUST=y/# CONFIG_RUST is not set/' .config
        sed -i 's/CONFIG_RUST_TOOLCHAIN=y/# CONFIG_RUST_TOOLCHAIN is not set/' .config

        # ðŸŽ¯ åªä¿ç•™ CPE-S10
        sed -i 's/^CONFIG_TARGET_qualcommax_ipq807x_DEVICE_.*/# &/' .config
        echo 'CONFIG_TARGET_qualcommax_ipq807x_DEVICE_cpe_s10=y' >> .config
        echo 'CONFIG_PACKAGE_kmod-qca-nss-drv=y' >> .config
        make defconfig

        echo "==== FINAL RUST CHECK ===="
        grep -i rust .config || echo "OK: no rust enabled"
        echo "==== NSS DRIVER CHECK ===="
        grep CONFIG_PACKAGE_kmod-qca-nss-drv .config || echo "WARN: NSS driver not in config"
        echo 'CONFIG_PACKAGE_kmod-qca-nss-drv=y' >> .config
    
    - name: Fix qca-nss-ecm Dependency
      run: |
        cd openwrt
        ECM_MAKEFILE="package/feeds/nss_packages/qca-nss-ecm/Makefile"
        
        # 1. æ·»åŠ ç¼–è¯‘æ—¶ä¾èµ– (ç›®æ ‡åæ˜¯ kmod-qca-nss-drvï¼Œä½†æºç ç›®å½•æ˜¯ qca-nss-drv)
        # PKG_BUILD_DEPENDS é€šå¸¸ä½¿ç”¨æºç åŒ…å
        sed -i '/^PKG_NAME:=qca-nss-ecm$/aPKG_BUILD_DEPENDS:=qca-nss-drv' "$ECM_MAKEFILE"
        
        # 2. ä¿®æ”¹ç¼–è¯‘å‘½ä»¤ä»¥ä¼ é€’ä¾èµ–åŒ…çš„ç¬¦å·è¡¨
        # KBUILD_EXTRA_SYMBOLS è·¯å¾„ä¸­çš„é€šé…ç¬¦åº”åŒ¹é…æºç ç›®å½•å
        sed -i '/define Build\/Compile/,/endef/ {
            s|$(MAKE) -C "$(LINUX_DIR)"|& KBUILD_EXTRA_SYMBOLS="$(TOPDIR)/build_dir/target-*/*qca-nss-drv*/Module.symvers"
        }' "$ECM_MAKEFILE"
        
        echo "å·²ä¿®å¤ä¾èµ–é…ç½®ã€‚å°†ä¾èµ–åŒ… 'qca-nss-drv' çš„ç¬¦å·è¡¨ä¼ é€’ç»™ 'qca-nss-ecm'ã€‚"
    
    - name: Find Correct NSS Driver Package Name
      run: |
        cd openwrt
        echo "=== æ ¸å¿ƒåŒ…åç¡®è®¤ ==="
        echo "ç¼–è¯‘ç›®æ ‡: kmod-qca-nss-drv"
        echo "æºç ç›®å½•: qca-nss-drv"
        
        echo -e "\n=== å…³é”®çŠ¶æ€æ£€æŸ¥ ==="
        # æ£€æŸ¥1: è¯¥åŒ…æ˜¯å¦åœ¨.configä¸­å¯ç”¨ (è¿™æ˜¯æ­¤å‰å¤±è´¥çš„ä¸»å› )
        if grep -q "^CONFIG_PACKAGE_kmod-qca-nss-drv=y" .config 2>/dev/null; then
          echo "âœ… é…ç½®çŠ¶æ€: å·²åœ¨ .config ä¸­å¯ç”¨"
        else
          echo "âŒ é…ç½®çŠ¶æ€: **æœªåœ¨ .config ä¸­å¯ç”¨**"
          echo "   è¯·ç¡®ä¿åœ¨ 'Load CI Config' æ­¥éª¤ä¸­å·²æ·»åŠ ï¼š"
          echo "   echo 'CONFIG_PACKAGE_kmod-qca-nss-drv=y' >> .config"
        fi
        
        # æ£€æŸ¥2: æºç ç›®å½•æ˜¯å¦å­˜åœ¨
        if [ -d "package/feeds/nss_packages/qca-nss-drv" ]; then
          echo "âœ… æºç ç›®å½•: å­˜åœ¨"
        else
          echo "âŒ æºç ç›®å½•: ä¸å­˜åœ¨"
        fi
        
        echo -e "\nè¯Šæ–­å®Œæˆã€‚è¯·æ ¹æ®ä¸Šæ–¹æ£€æŸ¥ç»“æžœè¿›è¡ŒåŽç»­æ“ä½œã€‚"
    
    - name: Compile qca-nss-ecm with Fixed Symbols
      run: |
        cd openwrt
        echo â€œæŸ¥æ‰¾ä¾èµ–åŒ…çš„ç¬¦å·è¡¨æ–‡ä»¶...â€
        # å…³é”®ï¼šæ ¹æ®å®žé™…æž¶æž„è·¯å¾„æŸ¥æ‰¾ï¼Œä½¿ç”¨æ›´ç²¾ç¡®çš„è·¯å¾„æ¨¡å¼
        SYMVERS_PATH=$(find build_dir/target-aarch64_cortex-a53_musl/linux-qualcommax_ipq807x -path "*/kmod-qca-nss-drv-*/Module.symvers" 2>/dev/null | head -n1)
        
        if [ -z "$SYMVERS_PATH" ]; then
          echo â€œé”™è¯¯ï¼šæœªæ‰¾åˆ° kmod-qca-nss-drv çš„ Module.symvers æ–‡ä»¶ã€‚â€
          echo â€œå°è¯•åˆ—å‡ºå¯èƒ½ç›®å½•...â€
          find build_dir -name â€œModule.symversâ€ 2>/dev/null || true
          exit 1
        fi
        
        echo â€œæ‰¾åˆ°ç¬¦å·è¡¨æ–‡ä»¶: $SYMVERS_PATHâ€
        echo â€œéªŒè¯æ–‡ä»¶ä¸­æ˜¯å¦åŒ…å«æ‰€éœ€ç¬¦å·...â€
        grep nss_rmnet_rx_get_ifnum â€œ$SYMVERS_PATHâ€ || echo â€œè­¦å‘Šï¼šç¬¦å·ä¸åœ¨è¯¥æ–‡ä»¶ä¸­ï¼Œå¯èƒ½éœ€è¦æ£€æŸ¥å…¶ä»–ä¾èµ–åŒ…ã€‚â€
        
        echo â€œå¼€å§‹ç¼–è¯‘ qca-nss-ecm...â€
        # é€šè¿‡çŽ¯å¢ƒå˜é‡ä¼ é€’ç¬¦å·è¡¨ç»å¯¹è·¯å¾„ï¼Œå¹¶å¼€å¯è¯¦ç»†æ—¥å¿—
        KBUILD_EXTRA_SYMBOLS=â€œ$SYMVERS_PATHâ€ make package/feeds/nss_packages/qca-nss-ecm/compile -j1 V=sc
        
    - name: Download Packages
      run: |
        cd openwrt
        make download -j$(nproc)

    - name: ðŸ” Diagnose Symbol Dependency
      id: diagnose_symbols
      run: |
        set -e
        cd openwrt || { echo "âŒ æ— æ³•è¿›å…¥ openwrt ç›®å½•"; exit 1; }
        
        echo "ðŸ“ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "=========================================="
        
        # 1. æœç´¢ç¬¦å·å®šä¹‰
        echo "ðŸ”Ž æ­¥éª¤ 1/3: æœç´¢ç¬¦å· 'nss_rmnet_rx_get_ifnum' çš„å®šä¹‰"
        echo "--------------------------------------------------"
        SYMBOL_SOURCES=$(find package/feeds -type f \( -name "*.c" -o -name "*.h" -o -name "*.mk" \) -exec grep -l "nss_rmnet_rx_get_ifnum" {} \; 2>/dev/null || true)
        
        if [ -n "$SYMBOL_SOURCES" ]; then
            echo "âœ… æ‰¾åˆ°ç¬¦å·å®šä¹‰ï¼Œä½äºŽä»¥ä¸‹æ–‡ä»¶:"
            echo "$SYMBOL_SOURCES" | while IFS= read -r file; do
                echo "   â€¢ $file"
                # å¯é€‰ï¼šæ˜¾ç¤ºåŒ¹é…è¡Œä¸Šä¸‹æ–‡
                # grep -n "nss_rmnet_rx_get_ifnum" "$file" | head -2 | sed 's/^/     /'
            done
            # æå–å¯èƒ½çš„åŒ…å
            PKG_CANDIDATES=$(echo "$SYMBOL_SOURCES" | sed 's|package/feeds/\([^/]*\)/.*|\1|' | sort -u)
            echo "ðŸ“¦ å¯èƒ½çš„æä¾›è€…åŒ…: $PKG_CANDIDATES"
        else
            echo "âš ï¸  æœªåœ¨ feeds ä¸­æ‰¾åˆ°ç¬¦å·å®šä¹‰"
            # æ‰©å¤§æœç´¢èŒƒå›´
            echo "ðŸ” æ‰©å¤§æœç´¢èŒƒå›´è‡³æ•´ä¸ªæºç æ ‘..."
            find . -type f \( -name "*.c" -o -name "*.h" \) -exec grep -l "nss_rmnet_rx_get_ifnum" {} \; 2>/dev/null | head -5 || echo "   (æœªæ‰¾åˆ°)"
        fi
        
        echo ""
        
        # 2. æ£€æŸ¥ä¾èµ–åŒ…çŠ¶æ€
        echo "ðŸ”§ æ­¥éª¤ 2/3: æ£€æŸ¥ä¾èµ–åŒ…ç¼–è¯‘çŠ¶æ€"
        echo "--------------------------------------------------"
        
        # å®šä¹‰è¦æ£€æŸ¥çš„åŒ…åˆ—è¡¨ï¼ˆå¯æ ¹æ®ä¸Šä¸€æ­¥ç»“æžœåŠ¨æ€è°ƒæ•´ï¼‰
        CHECK_PKGS="kmod-qca-nss-drv kmod-qca-nss-drv-ppe"
        FOUND_SYMVERS=""
        
        for PKG in $CHECK_PKGS; do
            echo "æ£€æŸ¥åŒ…: $PKG"
            
            # æŸ¥æ‰¾åŒ…ç›®å½•
            PKG_DIR=$(find package/feeds -type d -name "$PKG" 2>/dev/null | head -1)
            if [ -n "$PKG_DIR" ]; then
                echo "   ðŸ“ ä½ç½®: $PKG_DIR"
            else
                echo "   âš ï¸  æœªåœ¨ feeds ä¸­æ‰¾åˆ°åŒ…ç›®å½•"
            fi
            
            # æŸ¥æ‰¾ç¬¦å·è¡¨æ–‡ä»¶
            SYMVERS=$(find build_dir -type f -name "Module.symvers" -path "*$PKG*" 2>/dev/null | head -1)
            
            if [ -n "$SYMVERS" ]; then
                echo "   âœ… æ‰¾åˆ° Module.symvers"
                echo "      è·¯å¾„: $SYMVERS"
                
                # æ£€æŸ¥æ˜¯å¦åŒ…å«ç›®æ ‡ç¬¦å·
                if grep -q "nss_rmnet_rx_get_ifnum" "$SYMVERS"; then
                    echo "      åŒ…å«ç›®æ ‡ç¬¦å·: âœ…"
                    FOUND_SYMVERS="$SYMVERS"
                    # å°†æ‰¾åˆ°çš„è·¯å¾„è®¾ç½®ä¸ºæ­¥éª¤è¾“å‡ºï¼Œä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
                    echo "provider_symvers=$SYMVERS" >> "$GITHUB_OUTPUT"
                else
                    echo "      ä¸åŒ…å«ç›®æ ‡ç¬¦å·: âŒ"
                fi
                
                # æ˜¾ç¤ºå‰å‡ ä¸ªç¬¦å·ç¤ºä¾‹
                echo "      ç¬¦å·è¡¨ç¤ºä¾‹:"
                head -3 "$SYMVERS" | sed 's/^/        /'
            else
                echo "   âŒ æœªæ‰¾åˆ° Module.symvers (å¯èƒ½æœªç¼–è¯‘)"
                
                # æ£€æŸ¥æ˜¯å¦æœ‰ç¼–è¯‘ç›®å½•å­˜åœ¨
                BUILD_DIR=$(find build_dir -type d -name "*$PKG*" 2>/dev/null | head -1)
                if [ -n "$BUILD_DIR" ]; then
                    echo "      å­˜åœ¨æž„å»ºç›®å½•: $BUILD_DIR"
                    ls -la "$BUILD_DIR/" 2>/dev/null | grep -E "(Module|\.ko|\.o)" || true
                fi
            fi
            echo ""
        done
        
        # 3. æ£€æŸ¥ qca-nss-ecm é…ç½®çŠ¶æ€
        echo "ðŸ“‹ æ­¥éª¤ 3/3: æ£€æŸ¥ qca-nss-ecm é…ç½®çŠ¶æ€"
        echo "--------------------------------------------------"
        
        ECM_MAKEFILE="package/feeds/nss_packages/qca-nss-ecm/Makefile"
        
        if [ -f "$ECM_MAKEFILE" ]; then
            echo "âœ… Makefile å­˜åœ¨: $ECM_MAKEFILE"
            
            # æ£€æŸ¥ PKG_BUILD_DEPENDS
            echo "   1. PKG_BUILD_DEPENDS é…ç½®:"
            grep -n "PKG_BUILD_DEPENDS" "$ECM_MAKEFILE" || echo "      (æœªè®¾ç½®)"
            
            # æ£€æŸ¥ DEPENDS
            echo "   2. DEPENDS é…ç½®:"
            grep -n "^DEPENDS" "$ECM_MAKEFILE" || echo "      (æœªè®¾ç½®)"
            
            # æ£€æŸ¥ KBUILD_EXTRA_SYMBOLS
            echo "   3. KBUILD_EXTRA_SYMBOLS é…ç½®:"
            grep -n -A2 -B2 "KBUILD_EXTRA_SYMBOLS" "$ECM_MAKEFILE" || echo "      (æœªæ‰¾åˆ°)"
            
            # æ˜¾ç¤º Build/Compile éƒ¨åˆ†
            echo "   4. Build/Compile éƒ¨åˆ†:"
            sed -n '/define Build\/Compile/,/endef/p' "$ECM_MAKEFILE" | head -10 || echo "      (æ— æ³•æå–)"
        else
            echo "âŒ Makefile ä¸å­˜åœ¨: $ECM_MAKEFILE"
        fi
        
        echo ""
        echo "=========================================="
        echo "ðŸ“Š è¯Šæ–­æ‘˜è¦:"
        
        if [ -n "$FOUND_SYMVERS" ]; then
            echo "âœ… æ‰¾åˆ°åŒ…å«ç›®æ ‡ç¬¦å·çš„ Module.symvers: $FOUND_SYMVERS"
        else
            echo "âŒ æœªæ‰¾åˆ°åŒ…å«ç›®æ ‡ç¬¦å·çš„ Module.symvers"
        fi
        
        if [ -n "$SYMBOL_SOURCES" ]; then
            echo "âœ… æ‰¾åˆ°ç¬¦å·å®šä¹‰ï¼Œæä¾›è€…åŒ…å¯èƒ½æ˜¯: $(echo $PKG_CANDIDATES | tr '\n' ' ')"
        else
            echo "âš ï¸  æœªæ‰¾åˆ°ç¬¦å·å®šä¹‰ï¼Œå¯èƒ½éœ€è¦æ£€æŸ¥å…¶ä»–æºç "
        fi
        
        # è®¾ç½®æ­¥éª¤ç»“è®º
        if [ -n "$FOUND_SYMVERS" ]; then
            echo "diagnosis_result=success" >> "$GITHUB_OUTPUT"
        else
            echo "diagnosis_result=failed" >> "$GITHUB_OUTPUT"
        fi
    
    - name: Compile Firmware
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s

    - name: Upload Firmware
      if: success() && env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: Swaiot-CPE-S10-Firmware
        path: openwrt/bin/targets/ipq807x/*

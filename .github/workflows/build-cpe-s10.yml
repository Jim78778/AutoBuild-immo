name: Build Swaiot CPE-S10 ImmortalWrt

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  REPO_URL: https://github.com/Jim78778/immortalwrt-ipq.git
  REPO_BRANCH: Jim78778-patch-1
  TZ: Asia/Shanghai
  MAKE_JOBS: 8

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout CI repo
      uses: actions/checkout@v4

    - name: Set timezone
      run: |
        sudo timedatectl set-timezone "$TZ"

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        df -h

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses-dev libssl-dev python3 python3-distutils \
          rsync unzip zlib1g-dev file wget

    # ========= 获取 ImmortalWrt =========
    - name: Clone ImmortalWrt
      run: |
        git clone --depth=1 -b "$REPO_BRANCH" "$REPO_URL" openwrt

    # ========= 添加 QModem feed =========
    - name: Add QModem feed
      run: |
        cd openwrt
        echo "src-git qmodem https://github.com/FUjr/QModem.git" >> feeds.conf.default

    - name: Update & install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        ./scripts/feeds install -a -f -p qmodem

    # ========= 修正 QModem 依赖（关键） =========
    - name: Patch QModem dependencies
      run: |
        cd openwrt
        sed -i \
          -e 's/kmod-mhi-wwan/kmod-mhi-wwan-mbim kmod-mhi-wwan-ctrl/g' \
          -e 's/quectel-CM-5G//g' \
          package/feeds/qmodem/qmodem/Makefile

    # ========= 载入 config（只做一次） =========
    - name: Load base config
      run: |
        cd openwrt
        cp ../ci.config .config

    # ========= 强制 target / device（唯一位置） =========
    - name: Force target to Swaiot CPE-S10
      run: |
        cd openwrt

        # 清理所有旧 target（防止 generic）
        sed -i '/^CONFIG_TARGET_/d' .config

        # 明确写死 ipq807x + CPE-S10
        cat >> .config << 'EOF'
CONFIG_TARGET_qualcommax=y
CONFIG_TARGET_qualcommax_ipq807x=y
CONFIG_TARGET_qualcommax_ipq807x_DEVICE_swaiot_cpe_s10=y
EOF

        make defconfig

    # ========= 构建 =========
    - name: Build firmware
      run: |
        cd openwrt
        make -j$(nproc) V=s

    # ========= 上传固件 =========
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: CPE-S10-firmware
        path: openwrt/bin/targets/qualcommax/ipq807x/


name: Build Swaiot CPE-S10 ImmortalWrt

on:
  workflow_dispatch:
  push:
    branches:
      - patch-1

env:
  REPO_URL: https://github.com/Jim78778/immortalwrt-ipq.git
  REPO_BRANCH: Jim78778-patch-1
  CONFIG_FILE: ci.config
  FEEDS_CONF: feeds.conf.default
  TZ: Asia/Shanghai
  UPLOAD_FIRMWARE: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout CI Repo
      uses: actions/checkout@v4

    - name: Set Timezone
      run: sudo timedatectl set-timezone "$TZ"

    - name: Free Disk Space (IMPORTANT)
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt clean
        df -h

    - name: Install Build Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex g++ gawk gcc-multilib gettext \
          git libncurses5-dev libssl-dev python3 python3-distutils \
          rsync unzip zlib1g-dev file wget \
          libelf-dev ecj fastjar

    - name: Clone ImmortalWrt Source
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt

    - name: Add QModem feed
      run: |
        cd openwrt
        echo "src-git qmodem https://github.com/FUjr/QModem.git" >> feeds.conf.default

    - name: Update & Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load CI Config (single device, rust killed)
      run: |
        cd openwrt

        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "âŒ ci.config not found"
          exit 1
        fi

        cp $GITHUB_WORKSPACE/$CONFIG_FILE .config

        # ğŸš« å¼ºåˆ¶ç¦ç”¨ Rustï¼ˆåŒä¿é™©ï¼‰
        sed -i 's/CONFIG_RUST=y/# CONFIG_RUST is not set/' .config
        sed -i 's/CONFIG_RUST_TOOLCHAIN=y/# CONFIG_RUST_TOOLCHAIN is not set/' .config

        # ğŸ¯ åªä¿ç•™ CPE-S10
        sed -i 's/^CONFIG_TARGET_qualcommax_ipq807x_DEVICE_.*/# &/' .config
        echo 'CONFIG_TARGET_qualcommax_ipq807x_DEVICE_cpe_s10=y' >> .config
        # ğŸ”‘ ã€å…³é”®ã€‘å¯ç”¨æ ¸å¿ƒé©±åŠ¨åŒ… (åªéœ€ä¸€æ¬¡ï¼Œä¸”åœ¨ make defconfig ä¹‹å‰)
        echo 'CONFIG_PACKAGE_kmod-qca-nss-drv=y' >> .config

        make defconfig

        echo "==== FINAL RUST CHECK ===="
        grep -i rust .config || echo "OK: no rust enabled"
        echo "==== NSS DRIVER CHECK ===="
        grep CONFIG_PACKAGE_kmod-qca-nss-drv .config || echo "WARN: NSS driver not in config"

    - name: ä¿®å¤ qca-nss-ecm ä¾èµ–
      run: |
        cd openwrt
        ECM_MAKEFILE="package/feeds/nss_packages/qca-nss-ecm/Makefile"
        
        # 1. æ·»åŠ ç¼–è¯‘æ—¶ä¾èµ–
        sed -i '/^PKG_NAME:=qca-nss-ecm$/aPKG_BUILD_DEPENDS:=qca-nss-drv' "$ECM_MAKEFILE"
        
        # 2. ä¿®æ”¹ç¼–è¯‘å‘½ä»¤ä»¥ä¼ é€’ä¾èµ–åŒ…çš„ç¬¦å·è¡¨
        sed -i '/define Build\/Compile/,/endef/ {
            s|$(MAKE) -C "$(LINUX_DIR)"|& KBUILD_EXTRA_SYMBOLS="$(TOPDIR)/build_dir/target-*/*qca-nss-drv*/Module.symvers"|
        }' "$ECM_MAKEFILE"
        
        echo "å·²ä¿®å¤ä¾èµ–é…ç½®ã€‚å°†ä¾èµ–åŒ… 'qca-nss-drv' çš„ç¬¦å·è¡¨ä¼ é€’ç»™ 'qca-nss-ecm'ã€‚"

    - name: éªŒè¯é…ç½®ä¸ç›®å½•
      run: |
        cd openwrt
        echo "=== éªŒè¯å¼€å§‹ ==="
        echo "1. æ£€æŸ¥æ ¸å¿ƒé©±åŠ¨åŒ…é…ç½®..."
        if grep -q '^CONFIG_PACKAGE_kmod-qca-nss-drv=y$' .config; then
          echo "   âœ… é…ç½®å·²å¯ç”¨"
        else
          echo "   âŒ é…ç½®æœªå¯ç”¨ï¼Œç¼–è¯‘å°†å¤±è´¥"
          exit 1
        fi
        echo "2. æ£€æŸ¥æºç ç›®å½•..."
        if [ -d "package/feeds/nss_packages/qca-nss-drv" ]; then
          echo "   âœ… ç›®å½•å­˜åœ¨"
        else
          echo "   âŒ ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        echo "=== éªŒè¯é€šè¿‡ ==="

    - name: ç¼–è¯‘æ ¸å¿ƒä¾èµ–åŒ… (kmod-qca-nss-drv)
      run: |
        cd openwrt
        echo "å¼€å§‹ç¼–è¯‘ kmod-qca-nss-drv (ä½¿ç”¨æºç ç›®å½•å)..."
        # å…³é”®ï¼šä½¿ç”¨æºç ç›®å½•å 'qca-nss-drv'
        make package/feeds/nss_packages/qca-nss-drv/compile V=s
        echo "æ ¸å¿ƒä¾èµ–åŒ…ç¼–è¯‘å®Œæˆã€‚"
    
    - name: Download Packages
      run: |
        cd openwrt
        make download -j$(nproc)

    - name: Compile Firmware
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s

    - name: Upload Firmware
      if: success() && env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: Swaiot-CPE-S10-Firmware
        path: openwrt/bin/targets/ipq807x/*


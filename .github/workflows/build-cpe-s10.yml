name: Build Swaiot CPE-S10 (ImmortalWrt)

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  # ğŸ‘‰ é‡è¦ï¼šæºç ä»“åº“
  REPO_URL: https://github.com/Jim78778/immortalwrt-ipq.git

  # ğŸ‘‰ é‡è¦ï¼šå¿…é¡»æ˜¯å« DTS / BDF çš„åˆ†æ”¯
  REPO_BRANCH: Jim78778-patch-1

  # ğŸ‘‰ AutoBuild-immo ä»“åº“é‡Œçš„é…ç½®æ–‡ä»¶
  CONFIG_FILE: ci.config

  TZ: Asia/Shanghai
  UPLOAD_FIRMWARE: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout AutoBuild Repo
      uses: actions/checkout@v4

    - name: Set Timezone
      run: sudo timedatectl set-timezone "$TZ"

    - name: Install Build Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex g++ gawk gcc-multilib gettext \
          git libncurses5-dev libssl-dev python3 python3-distutils \
          rsync unzip zlib1g-dev file wget \
          libelf-dev ecj fastjar

    # =========================================================
    # Clone ImmortalWrt Source (å…³é”®ï¼šç¡®è®¤åˆ†æ”¯)
    # =========================================================
    - name: Clone ImmortalWrt Source
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        echo "==== IMMORTALWRT SOURCE CHECK ===="
        git log -1 --oneline
        echo "================================="

    # =========================================================
    # Add QModem feed
    # =========================================================
    - name: Add QModem feed
      run: |
        cd openwrt
        echo "src-git qmodem https://github.com/FUjr/QModem.git" >> feeds.conf.default

    # =========================================================
    # Update & Install Feeds
    # =========================================================
    - name: Update & Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # =========================================================
    # Load CI config (single device + rust kill)
    # =========================================================
    - name: Load CI Config (CPE-S10 only)
      run: |
        cd openwrt

        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "âŒ ci.config not found"
          exit 1
        fi

        cp $GITHUB_WORKSPACE/$CONFIG_FILE .config

        # â— å¼ºåˆ¶åªç¼–ä¸€ä¸ªè®¾å¤‡ï¼ˆé˜²æ­¢ mx4200 / å…¶ä»–æœºå‹ï¼‰
        sed -i 's/^CONFIG_TARGET_qualcommax_ipq807x_DEVICE_.*/# &/' .config
        echo 'CONFIG_TARGET_qualcommax_ipq807x_DEVICE_cpe_s10=y' >> .config

        # ğŸš« Rust å®Œå…¨ç¦ç”¨ï¼ˆé¿å… host rust / checksum / vendor é”™ï¼‰
        sed -i 's/CONFIG_RUST=y/# CONFIG_RUST is not set/' .config
        sed -i 's/CONFIG_RUST_TOOLCHAIN=y/# CONFIG_RUST_TOOLCHAIN is not set/' .config

        yes "" | make defconfig

        echo "==== FINAL CONFIG CHECK ===="
        grep -E "cpe_s10|RUST" .config || true
        echo "============================"

    # =========================================================
    # Download packages (å¹¶å‘å°ä¸€ç‚¹é˜²æ­¢çˆ†ç›˜)
    # =========================================================
    - name: Download Packages
      run: |
        cd openwrt
        make download -j2

    # =========================================================
    # Build Firmwareï¼ˆå…ˆå¹¶è¡Œï¼Œå¤±è´¥è‡ªåŠ¨é™çº§ï¼‰
    # =========================================================
    - name: Compile Firmware
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s

    # =========================================================
    # Upload Firmware
    # =========================================================
    - name: Upload Firmware
      if: success() && env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: Swaiot-CPE-S10-Firmware
        path: openwrt/bin/targets/ipq807x/*/



name: Build CPE-S10 (MHI + QModem)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Prepare environment
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib gettext git libncurses-dev libssl-dev python3 \
          python3-distutils rsync unzip zlib1g-dev file wget time

    - name: Clone ImmortalWrt
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt openwrt

    # =========================
    # ðŸ”¥ æ³¨å…¥ CPE-S10 è®¾å¤‡å®šä¹‰ï¼ˆå…³é”®ï¼‰
    # =========================
    - name: Inject CPE-S10 device
      run: |
        cd openwrt

        # DTS
        cp ../target/ipq8071-s10.dts \
          target/linux/qualcommax/ipq807x/files/

        # Device definition
        cat << 'EOF' >> target/linux/qualcommax/ipq807x/target.mk

        define Device/cpe_s10
          $(call Device/FitImage)
          DEVICE_VENDOR := Swaiot
          DEVICE_MODEL := CPE-S10
          DEVICE_DTS := ipq8071-s10
        endef
        TARGET_DEVICES += cpe_s10
        EOF

    - name: Update & install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load configs
      run: |
        if [ ! -f "ci.config" ]; then
          echo "âŒ ci.config not found"
          exit 1
        fi

        cp ci.config openwrt/.config

        if [ -f "swaiot.config" ]; then
          cat swaiot.config >> openwrt/.config
        fi

    - name: Make defconfig
      run: |
        cd openwrt
        make defconfig

        echo "==== Selected device ===="
        grep "^CONFIG_TARGET_qualcommax_ipq807x_DEVICE" .config || true

    - name: Download packages
      run: |
        cd openwrt
        make download -j$(nproc)

    - name: Build firmware
      run: |
        cd openwrt
        make -j$(nproc) V=s

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: CPE-S10-firmware
        path: openwrt/bin/targets/


name: Build Swaiot CPE-S10 ImmortalWrt

on:
  workflow_dispatch:
  push:
    branches:
      - patch-1

env:
  REPO_URL: https://github.com/Jim78778/immortalwrt-ipq.git
  REPO_BRANCH: Jim78778-patch-1
  CONFIG_FILE: ci.config
  FEEDS_CONF: feeds.conf.default
  TZ: Asia/Shanghai
  UPLOAD_FIRMWARE: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout CI Repo
      uses: actions/checkout@v4

    - name: Set Timezone
      run: sudo timedatectl set-timezone "$TZ"

    - name: Free Disk Space (IMPORTANT)
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt clean
        df -h

    - name: Install Build Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex g++ gawk gcc-multilib gettext \
          git libncurses5-dev libssl-dev python3 python3-distutils \
          rsync unzip zlib1g-dev file wget \
          libelf-dev ecj fastjar

    - name: Clone ImmortalWrt Source
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt

    - name: Add QModem feed
      run: |
        cd openwrt
        echo "src-git qmodem https://github.com/FUjr/QModem.git" >> feeds.conf.default

    - name: Update & Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load CI Config (single device, rust killed)
      run: |
        cd openwrt
        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "❌ ci.config not found"
          exit 1
        fi
        cp $GITHUB_WORKSPACE/$CONFIG_FILE .config
        sed -i 's/CONFIG_RUST=y/# CONFIG_RUST is not set/' .config
        sed -i 's/CONFIG_RUST_TOOLCHAIN=y/# CONFIG_RUST_TOOLCHAIN is not set/' .config
        sed -i 's/^CONFIG_TARGET_qualcommax_ipq807x_DEVICE_.*/# &/' .config
        echo 'CONFIG_TARGET_qualcommax_ipq807x_DEVICE_cpe_s10=y' >> .config
        echo 'CONFIG_PACKAGE_kmod-qca-nss-drv=y' >> .config
        make defconfig
        echo "==== 配置检查 ===="
        grep CONFIG_PACKAGE_kmod-qca-nss-drv .config || echo "状态: 未启用"

    - name: 诊断并修复NSS符号依赖
      run: |
        cd openwrt
        echo "=== 步骤1: 强制启用核心驱动包 ==="
        sed -i '/CONFIG_PACKAGE_kmod-qca-nss-drv/d' .config
        echo 'CONFIG_PACKAGE_kmod-qca-nss-drv=y' >> .config
        
        echo "=== 步骤2: 查找真正的符号表文件 ==="
        SYM_PATH=$(find build_dir -name "Module.symvers" -path "*kmod-qca-nss-drv-*" 2>/dev/null | head -1)
        
        if [ -z "$SYM_PATH" ]; then
          echo "未找到已编译的符号表，将使用通配符路径。"
          SYM_PATH="\$(TOPDIR)/build_dir/target-*/kmod-qca-nss-drv-*/Module.symvers"
        else
          echo "找到符号表: $SYM_PATH"
          if grep -q "nss_rmnet_rx_get_ifnum" "$SYM_PATH"; then
            echo "所需符号已存在。"
          fi
        fi
        
        echo "=== 步骤3: 修复 ecm Makefile (关键修正) ==="
        ECM_MAKEFILE="package/feeds/nss_packages/qca-nss-ecm/Makefile"
        
        # 1. 清理旧配置并添加依赖
        sed -i '/PKG_BUILD_DEPENDS.*qca-nss-drv/d' "$ECM_MAKEFILE"
        sed -i '/^PKG_NAME:=qca-nss-ecm$/aPKG_BUILD_DEPENDS:=kmod-qca-nss-drv' "$ECM_MAKEFILE"
        
        # 2. 创建临时修复脚本，避免YAML格式问题
        cat > /tmp/fix_ecm.sh << 'EOF'
        #!/bin/bash
        MAKEFILE="$1"
        SYM_PATH="$2"
        
        # 使用awk安全地插入KBUILD_EXTRA_SYMBOLS，这是最可靠的方法
        awk -v sym_path="$SYM_PATH" '
        /define Build\/Compile/ { in_block=1; print $0; next }
        in_block && /^[[:space:]]*\$(MAKE)[[:space:]]+-C[[:space:]]+"\$(LINUX_DIR)"/ {
          print $0 " KBUILD_EXTRA_SYMBOLS=\"" sym_path "\""
          inserted=1
          next
        }
        in_block && /^endef/ {
          if (!inserted) {
            print "\tKBUILD_EXTRA_SYMBOLS=\"" sym_path "\""
          }
          in_block=0
          inserted=0
        }
        { print $0 }
        ' "$MAKEFILE" > "$MAKEFILE.fixed" && mv "$MAKEFILE.fixed" "$MAKEFILE"
        EOF
        
        bash /tmp/fix_ecm.sh "$ECM_MAKEFILE" "$SYM_PATH"
        echo "✅ 修复完成。符号表路径: $SYM_PATH""

    - name: Download Packages
      run: |
        cd openwrt
        make download -j$(nproc)

    - name: Compile Firmware
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s

    - name: Upload Firmware
      if: success() && env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: Swaiot-CPE-S10-Firmware
        path: openwrt/bin/targets/ipq807x/*

name: Build Swaiot CPE-S10 ImmortalWrt

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. Checkout CI repo
    - uses: actions/checkout@v4

    # 2. 检查服务器配置
    - name: 检查服务器配置
      run: |
        echo "若分配的服务器性能不足，务必及时取消，重新运行！"
        echo -e "------------------------------- CPU信息 -------------------------------\n"
        echo "CPU物理数量:$(grep 'physical id' /proc/cpuinfo | sort -u | wc -l)"
        echo -e "CPU核心及版本信息: $(grep 'name' /proc/cpuinfo | cut -f2 -d: | uniq -c) \n"
        echo -e "------------------------------- 内存信息 -------------------------------\n"
        echo "已安装内存详细信息: "
        sudo lshw -short -C memory | grep GiB || true
        echo -e "\n------------------------------- 磁盘信息 -------------------------------\n"
        echo "磁盘数量: $(ls /dev/sd* | grep -v '[1-9]' | wc -l)"
        echo -e "------------------------------- 磁盘详情 -------------------------------\n"
        df -Th

    # 3. Install dependencies
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils \
          bison build-essential bzip2 ccache clang cmake cpio curl \
          device-tree-compiler flex gawk bc gettext git gperf help2man \
          intltool libelf-dev libncurses-dev libssl-dev python3 \
          python3-distutils rsync unzip wget zlib1g-dev zstd lshw
        sudo timedatectl set-timezone "$TZ"

    # 4. Clone ImmortalWrt (your branch)
    - name: Clone ImmortalWrt
      run: |
        git clone https://github.com/Jim78778/immortalwrt-ipq.git openwrt
        cd openwrt
        git checkout Jim78778-patch-1
        ./scripts/getver.sh

    # 5. Verify device exists
    - name: Verify S10 device
      run: |
        cd openwrt
        grep -R "Device/swaiot_cpe_s10" target/linux/qualcommax/image || exit 1
        test -f target/linux/qualcommax/files/arch/arm64/boot/dts/qcom/ipq8071-s10.dts

    # 6. Add QModem feed
    - name: Add QModem feed
      run: |
        cd openwrt
        echo 'src-git qmodem https://github.com/FUjr/QModem.git;main' >> feeds.conf.default

    # 7. Update feeds
    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 8. Patch QModem Makefiles（可选，彻底消除 quectel-CM 旧依赖警告）
    - name: Patch QModem Makefiles
      run: |
        cd openwrt
        find package/feeds/qmodem -type f -name 'Makefile' -exec sed -i 's/quectel-CM-5G/quectel_CM_5G_M/g' {} +

    # 9. Apply ci.config
    - name: Apply ci.config
      run: |
        cd openwrt
        cat ../ci.config > .config

    # 10. Force S10 target
    - name: Force S10 target
      run: |
        cd openwrt
        sed -i '/DEVICE_swaiot_cpe_s10/d' .config
        cat >> .config << 'EOF'
        CONFIG_TARGET_qualcommax=y
        CONFIG_TARGET_qualcommax_ipq807x=y
        CONFIG_TARGET_qualcommax_ipq807x_DEVICE_swaiot_cpe_s10=y
        EOF

    # 11. defconfig
    - name: Make defconfig V=s
      run: |
        cd openwrt
        make defconfig
        grep swaiot_cpe_s10 .config || exit 1

    # 12. Download
    - name: Download packages
      run: |
        cd openwrt
        make download -j$(nproc)

    # 13. Build
    - name: Build firmware
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s

    # 14. Verify output
    - name: Verify firmware
      run: |
        ls -lh openwrt/bin/targets/qualcommax/ipq807x/
        ls openwrt/bin/targets/qualcommax/ipq807x/ || exit 1

    # 15. Upload
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: Swaiot-CPE-S10
        path: openwrt/bin/targets/qualcommax/ipq807x/*

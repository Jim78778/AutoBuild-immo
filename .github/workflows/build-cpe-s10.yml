name: Build Swaiot CPE-S10 ImmortalWrt

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # -------------------------------------------------
    # 1. Checkout（只拿 workflow 仓库）
    # -------------------------------------------------
    - name: Checkout
      uses: actions/checkout@v4

    # -------------------------------------------------
    # 2. Install full build dependencies（完整表）
    # -------------------------------------------------
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils \
          bison build-essential bzip2 ccache clang cmake cpio curl \
          device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib \
          g++-multilib git gnutls-dev gperf haveged help2man intltool \
          lib32gcc-s1 libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev \
          libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev \
          libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm \
          lrzsz mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf \
          python3 python3-pip python3-ply python3-docutils python3-pyelftools \
          qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo \
          uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd jq
        sudo timedatectl set-timezone "$TZ"

    # -------------------------------------------------
    # 3. Clone ImmortalWrt
    # -------------------------------------------------
    - name: Clone ImmortalWrt
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git openwrt
        cd openwrt
        ./scripts/getver.sh

    # -------------------------------------------------
    # 4. Add QModem feed
    # -------------------------------------------------
    - name: Add QModem feed
      run: |
        cd openwrt
        echo 'src-git qmodem https://github.com/FUjr/QModem.git;main' >> feeds.conf.default
        tail -n 5 feeds.conf.default

    # -------------------------------------------------
    # 5. Update & install feeds
    # -------------------------------------------------
    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # -------------------------------------------------
    # 6. Apply diy-part1（你自己的逻辑）
    # -------------------------------------------------
    - name: DIY part 1
      run: |
        cd openwrt
        if [ -f ../diy-part1.sh ]; then
          chmod +x ../diy-part1.sh
          ../diy-part1.sh
        fi

    # -------------------------------------------------
    # 7. Apply ci.config（关键）
    # -------------------------------------------------
    - name: Apply ci.config
      run: |
        cd openwrt
        cp ../ci.config .config

    # -------------------------------------------------
    # 8. Force CPE-S10 target（防 defconfig 覆盖）
    # -------------------------------------------------
    - name: Force CPE-S10 target
      run: |
        cd openwrt
        sed -i '/^CONFIG_TARGET_/d' .config
        cat >> .config << 'EOF'
        CONFIG_TARGET_qualcommax=y
        CONFIG_TARGET_qualcommax_ipq807x=y
        CONFIG_TARGET_qualcommax_ipq807x_DEVICE_swaiot_cpe_s10=y
        EOF
        grep CONFIG_TARGET_ .config

    # -------------------------------------------------
    # 9. Ensure QModem + MHI + PCIe (核心修复点)
    # -------------------------------------------------
    - name: Enable QModem & MHI
      run: |
        cd openwrt
        cat >> .config << 'EOF'
        CONFIG_PACKAGE_qmodem=y
        CONFIG_PACKAGE_luci-app-qmodem=y
        CONFIG_PACKAGE_kmod-mhi-wwan=y
        CONFIG_PACKAGE_kmod-mhi-wwan-ctrl=y
        CONFIG_PACKAGE_kmod-mhi-pci-generic=y
        CONFIG_PACKAGE_kmod-pcie_mhi=y
        CONFIG_PCI=y
        CONFIG_PCIE_QCOM=y
        EOF

    # -------------------------------------------------
    # 10. defconfig
    # -------------------------------------------------
    - name: Make defconfig
      run: |
        cd openwrt
        make defconfig
        grep -E 'QMODEM|MHI|PCIE' .config || true

    # -------------------------------------------------
    # 11. Download
    # -------------------------------------------------
    - name: Download packages
      run: |
        cd openwrt
        make download -j$(nproc)

    # -------------------------------------------------
    # 12. Build
    # -------------------------------------------------
    - name: Build firmware
      run: |
        cd openwrt
        make -j$(nproc) V=s

    # -------------------------------------------------
    # 13. Upload firmware
    # -------------------------------------------------
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: CPE-S10-firmware
        path: openwrt/bin/targets/
        retention-days: 30


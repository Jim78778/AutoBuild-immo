name: Build CPE-S10 (ipq807x + MHI + QModem + NSS)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      MAKE_JOBS: 16

    steps:
    # ------------------------------------------------------
    # 0. 显示 Runner 信息（你要求的）
    # ------------------------------------------------------
    - name: Show system info
      run: |
        echo "CPU: $(nproc)"
        free -h
        df -h /

    # ------------------------------------------------------
    # 1. Checkout 你的仓库（含 ci.config / swaiot.config）
    # ------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ------------------------------------------------------
    # 2. 释放 GitHub Runner 磁盘（关键，防止 No space）
    # ------------------------------------------------------
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
        sudo apt clean
        df -h /

    # ------------------------------------------------------
    # 3. 安装编译依赖（不装 Rust）
    # ------------------------------------------------------
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex bison g++ gawk \
          libncurses-dev libssl-dev zlib1g-dev \
          python3 python3-distutils \
          git gettext rsync wget curl file unzip time

    # ------------------------------------------------------
    # 4. Clone ImmortalWrt（官方源）
    # ------------------------------------------------------
    - name: Clone ImmortalWrt
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt openwrt

    # ------------------------------------------------------
    # 5. 注入 CPE-S10 设备（关键：避免 aliyun_ap8220）
    # ------------------------------------------------------
    - name: Register CPE-S10 device
      run: |
        cd openwrt

        cat << 'EOF' >> target/linux/qualcommax/ipq807x/target.mk

        define Device/cpe_s10
          \$(call Device/FitImage)
          DEVICE_VENDOR := Swaiot
          DEVICE_MODEL := CPE-S10
          DEVICE_DTS := ipq8071-s10
        endef
        TARGET_DEVICES += cpe_s10

        EOF

    # ------------------------------------------------------
    # 6. 添加 QModem feed
    # ------------------------------------------------------
    - name: Add QModem feed
      run: |
        cd openwrt
        echo "src-git qmodem https://github.com/FUjr/QModem.git" >> feeds.conf.default

    # ------------------------------------------------------
    # 7. 更新 & 安装 feeds（顺序固定）
    # ------------------------------------------------------
    - name: Update & install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        ./scripts/feeds install -a -p qmodem

    # ------------------------------------------------------
    # 8. 加载配置（严格顺序，防止被覆盖）
    # ------------------------------------------------------
    
    - name: Register CPE-S10 device
      run: |
       cd openwrt

        cat << 'EOF' >> target/linux/qualcommax/ipq807x/target.mk

        define Device/cpe_s10
        \$(call Device/FitImage)
        DEVICE_VENDOR := Swaiot
        DEVICE_MODEL := CPE-S10
        DEVICE_DTS := ipq8071-s10
       endef
       TARGET_DEVICES += cpe_s10

        EOF

    
    - name: Apply configuration
      run: |
        cd openwrt

        # 基础配置
        cp ../ci.config .config

        # 设备 / MHI / QModem / NSS 配置
        cat ../swaiot.config >> .config

        # 禁 Rust（硬保险）
        sed -i '/CONFIG_RUST/d' .config
        sed -i '/CONFIG_CARGO/d' .config
        echo "# CONFIG_RUST is not set" >> .config
        echo "# CONFIG_PACKAGE_rust is not set" >> .config
        echo "# CONFIG_PACKAGE_cargo is not set" >> .config

        make defconfig

    # ------------------------------------------------------
    # 9. 校验（防止再翻车）
    # ------------------------------------------------------
    - name: Verify target & packages
      run: |
        cd openwrt
        grep -E "cpe_s10|ipq8071-s10" .config || true
        grep -E "qmodem|kmod-mhi" .config || true

    # ------------------------------------------------------
    # 10. 下载源码（控磁盘）
    # ------------------------------------------------------
    - name: Download sources
      run: |
        cd openwrt
        make download -j8
        find dl -size +50M -delete

    # ------------------------------------------------------
    # 11. 编译
    # ------------------------------------------------------
    - name: Build firmware
      run: |
        cd openwrt
        time make -j$(nproc) || make -j1 V=s

    # ------------------------------------------------------
    # 12. 上传产物
    # ------------------------------------------------------
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: CPE-S10-ipq807x
        path: openwrt/bin/targets/
        retention-days: 7



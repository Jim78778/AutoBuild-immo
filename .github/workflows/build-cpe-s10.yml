name: Build Swaiot CPE-S10 ImmortalWrt

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  TZ: Asia/Shanghai
  MAKE_JOBS: 8

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # ---------------------------
    # 1. Checkout
    # ---------------------------
    - name: Checkout ImmortalWrt source
      uses: actions/checkout@v4

    # ---------------------------
    # 2. Setup environment
    # ---------------------------
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential gcc g++ gawk flex bison gettext libncurses-dev \
          libssl-dev zlib1g-dev file wget curl unzip git rsync python3 python3-distutils \
          ca-certificates ccache make cmake ninja-build autoconf automake \
          texinfo libtool lsb-release pkg-config bzip2 bc python3-pip
        sudo timedatectl set-timezone "$TZ"

    # ---------------------------
    # 3. Clone ImmortalWrt
    # ---------------------------
    - name: Clone ImmortalWrt
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git openwrt
        cd openwrt
        echo "IMMORTALWRT HEAD:"
        git log -1 --oneline

    # ---------------------------
    # 4. Add QModem feed
    # ---------------------------
    - name: Add QModem feed
      run: |
        cd openwrt
        echo "src-git qmodem https://github.com/FUjr/QModem.git;main" >> feeds.conf.default
        tail -n 3 feeds.conf.default

    # ---------------------------
    # 5. Update & install feeds
    # ---------------------------
    - name: Update & install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a -f

    # ---------------------------
    # 6. Patch QModem dependencies
    # ---------------------------
    - name: Patch QModem Makefile
      run: |
        cd openwrt
        if [ ! -f package/feeds/qmodem/qmodem/Makefile ]; then
          echo "ERROR: QModem Makefile not found"
          exit 1
        fi
        sed -i \
          -e 's/kmod-mhi-wwan/kmod-mhi-wwan-mbim kmod-mhi-wwan-ctrl/g' \
          -e 's/quectel-CM-5G//g' \
          package/feeds/qmodem/qmodem/Makefile
        sed -i -e 's/quectel-CM-5G//g' package/feeds/qmodem/luci-app-qmodem/Makefile
        echo "=== Patched QModem deps ==="
        grep DEPENDS package/feeds/qmodem/qmodem/Makefile || true

    # ---------------------------
    # 7. Force CPE-S10 target
    # ---------------------------
    - name: Force CPE-S10 target
      run: |
        cd openwrt
        # 清空旧 target
        sed -i '/^CONFIG_TARGET_/d' .config || true
        printf '%s\n' \
          'CONFIG_TARGET_qualcommax=y' \
          'CONFIG_TARGET_qualcommax_ipq807x=y' \
          'CONFIG_TARGET_qualcommax_ipq807x_DEVICE_swaiot_cpe_s10=y' \
          >> .config
        grep CONFIG_TARGET_ .config

    # ---------------------------
    # 8. Make defconfig
    # ---------------------------
    - name: Make defconfig
      run: |
        cd openwrt
        make defconfig
        grep CONFIG_TARGET_ .config

    # ---------------------------
    # 9. Download sources
    # ---------------------------
    - name: Download packages
      run: |
        cd openwrt
        make download -j$MAKE_JOBS

    # ---------------------------
    # 10. Build firmware
    # ---------------------------
    - name: Build firmware
      run: |
        cd openwrt
        make -j$MAKE_JOBS V=s

    # ---------------------------
    # 11. Upload firmware
    # ---------------------------
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: CPE-S10-firmware
        path: openwrt/bin/targets/
        retention-days: 30

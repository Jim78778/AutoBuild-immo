name: Build CPE-S10 (MHI + QModem) - GitHub Runner

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Build target'
        required: false
        default: 'full'
        type: choice
        options: [full, kernel, packages]
      use_ccache:
        description: 'Enable CCache'
        required: false
        default: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      CCACHE_DIR: /tmp/ccache
      CCACHE_MAXSIZE: 8G
      MAKE_JOBS: 16
      BUILD_TYPE: ${{ github.event.inputs.target || 'full' }}
      USE_CCACHE: ${{ github.event.inputs.use_ccache }}

    steps:
    - name: Check runner resources
      run: |
        echo "CPU: $(nproc)"
        free -h
        df -h /

    - name: Checkout repository
      uses: actions/checkout@v4

    # ✅ 必须：释放磁盘空间
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
        sudo apt clean
        df -h /

    - name: Setup build environment
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential ccache clang flex bison g++ gawk \
          libncurses-dev libssl-dev zlib1g-dev \
          python3 python3-distutils \
          git gettext rsync wget curl file unzip time

        if [ "${USE_CCACHE}" = "true" ]; then
          echo "CC=ccache gcc" >> $GITHUB_ENV
          echo "CXX=ccache g++" >> $GITHUB_ENV
          ccache --set-config=max_size=8G
          ccache -z
        fi

    - name: Clone ImmortalWrt
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt openwrt

    # ✅ 关键：加入 QModem feed
    - name: Add QModem feed
      run: |
        cd openwrt
        echo "src-git qmodem https://github.com/FUjr/QModem.git" >> feeds.conf.default

    - name: Update & install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        ./scripts/feeds install -a -p qmodem

    # ✅ 安全加载 config（顺序固定）
    - name: Apply configuration
      run: |
        cd openwrt
        cp ../ci.config .config
        cat ../swaiot.config >> .config
        make defconfig

    - name: Verify QModem & MHI
      run: |
        cd openwrt
        grep -R "qmodem" feeds || true
        grep -R "kmod-mhi" package || true

    - name: Download packages
      run: |
        cd openwrt
        make download -j$(nproc)
        find dl -size +50M -delete

    - name: Build firmware
      run: |
        cd openwrt
        time make -j$(nproc) || make -j1 V=s

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.sha }}
        path: openwrt/bin/targets/
        retention-days: 7


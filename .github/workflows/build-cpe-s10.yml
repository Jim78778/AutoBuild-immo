name: Build Swaiot CPE-S10 ImmortalWrt (NSS + ECM Experimental)

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/Jim78778/immortalwrt-ipq.git
  REPO_BRANCH: Jim78778-patch-1
  CONFIG_FILE: ci.config
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Install deps
      run: |
        sudo apt update
        sudo apt install -y build-essential git libncurses5-dev gawk gettext \
          python3 python3-distutils rsync unzip file wget libelf-dev bc

    - name: Clone source
      run: git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt

    - name: Add QModem feed
      run: |
        cd openwrt
        echo "src-git qmodem https://github.com/FUjr/QModem.git" >> feeds.conf.default

    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load Config (ECM enabled – risky)
      run: |
        cd openwrt
        cp $GITHUB_WORKSPACE/$CONFIG_FILE .config

        sed -i 's/^CONFIG_TARGET_qualcommax_ipq807x_DEVICE_.*/# &/' .config
        echo 'CONFIG_TARGET_qualcommax_ipq807x_DEVICE_cpe_s10=y' >> .config

        # 强制开启 ECM + RMNET
        echo 'CONFIG_PACKAGE_kmod-qca-nss-ecm=y' >> .config
        echo 'CONFIG_ECM_INTERFACE_RMNET_ENABLE=y' >> .config
        echo 'CONFIG_ECM_INTERFACE_RAWIP_ENABLE=y' >> .config
        echo 'CONFIG_ECM_FRONT_END_NSS_ENABLE=y' >> .config

        make defconfig

    - name: Build
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s
   
    - name: NSS / QModem Sanity Check
      run: |
        cd openwrt

        find bin/packages -name '*nss-drv*.ipk' | grep -q . || {
          echo "❌ kmod-qca-nss-drv missing"; exit 1; }

        find bin/packages -name '*qmodem*.ipk' | grep -q . || {
          echo "❌ qmodem missing"; exit 1; }

        echo "✅ NSS + QModem OK (no ECM)"

    - name: Upload Firmware
      if: success() && env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: Swaiot-CPE-S10-NSS-noECM
        path: openwrt/bin/targets/qualcommax/ipq807x/*



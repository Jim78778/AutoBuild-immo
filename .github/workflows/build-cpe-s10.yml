name: Build CPE-S10 (ImmortalWrt + MHI + QModem)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      MAKE_JOBS: 8

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # é‡Šæ”¾ç£ç›˜ï¼Œé˜²æ­¢ No space left on device
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
        sudo apt clean
        df -h /

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses-dev libssl-dev python3 python3-distutils \
          rsync unzip zlib1g-dev file wget curl time

    - name: Clone ImmortalWrt (your fork)
      run: |
        git clone --depth=1 -b Jim78778-patch-1 \
          https://github.com/Jim78778/immortalwrt-ipq.git openwrt

    - name: Add QModem feed
      run: |
        cd openwrt
        echo "src-git qmodem https://github.com/FUjr/QModem.git" >> feeds.conf.default

    - name: Update & install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        ./scripts/feeds install -a -p qmodem

    # ğŸ”¥ å…³é”®ä¿®å¤ï¼šè®© QModem é€‚é… ImmortalWrt
    - name: Patch QModem dependencies
      run: |
        cd openwrt
        sed -i \
          -e 's/kmod-mhi-wwan/kmod-mhi-wwan-mbim kmod-mhi-wwan-ctrl/g' \
          -e 's/quectel-CM-5G//g' \
          package/feeds/qmodem/qmodem/Makefile

    - name: Load config
      run: |
        cd openwrt
        cp ../ci.config .config

    - name: Make defconfig
      run: |
        cd openwrt
        make defconfig

    - name: Download packages
      run: |
        cd openwrt
        make download -j$MAKE_JOBS
        find dl -size +50M -delete

    - name: Build firmware
      run: |
        cd openwrt
        make -j$MAKE_JOBS || make -j1 V=s

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: CPE-S10-firmware
        path: openwrt/bin/targets/qualcommax/ipq807x/
        retention-days: 7

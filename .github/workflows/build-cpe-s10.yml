name: Build ImmortalWrt IPQ807x CPE-S10 (NSS + QModem + Passwall Xray, No Rust)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - patch-1

env:
  REPO_URL: https://github.com/Jim78778/immortalwrt-ipq.git
  REPO_BRANCH: Jim78778-patch-1
  CONFIG_FILE: ci.config
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout CI Repo
        uses: actions/checkout@v4

      - name: Set Timezone
        run: sudo timedatectl set-timezone "$TZ"

      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt clean
          df -h

      - name: Install Build Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential clang flex g++ gawk gcc-multilib gettext \
            git libncurses5-dev libssl-dev python3 python3-distutils \
            rsync unzip zlib1g-dev file wget \
            libelf-dev ecj fastjar

      - name: Clone ImmortalWrt Source
        run: |
          git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt

      - name: Add QModem Feed
        run: |
          cd openwrt
          echo "src-git qmodem https://github.com/FUjr/QModem.git" >> feeds.conf.default

      - name: Update & Install Feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Load ci.config
        run: |
          cd openwrt
          if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
            echo "ci.config not found"
            exit 1
          fi
          cp $GITHUB_WORKSPACE/$CONFIG_FILE .config
          make defconfig

      - name: Disable HAProxy QUIC (OpenSSL 3.x fix)
        run: |
          cd openwrt
          HAPROXY_MK="feeds/packages/net/haproxy/Makefile"
          sed -i 's/USE_QUIC=1/USE_QUIC=0/g' $HAPROXY_MK

      - name: Final Safety Check
        run: |
          cd openwrt
          echo "==== FINAL CONFIG CHECK ===="

          # 只检查真正启用的 Rust
          grep -E '^(CONFIG_RUST=y|CONFIG_RUST_TOOLCHAIN=y|CONFIG_PACKAGE_rust=y|CONFIG_PACKAGE_cargo=y)' .config && {
            echo "❌ Rust ENABLED"
            exit 1
          }

           # 只检查真正启用的 Shadowsocks
           grep -E '^CONFIG_PACKAGE_.*shadowsocks.*=y' .config && {
             echo "❌ Shadowsocks ENABLED"
             exit 1
           }

            # NSS 必须存在
            grep -E "CONFIG_PACKAGE_kmod-qca-nss-drv(=y|=m)" .config || {
              echo "❌ NSS driver missing"
              exit 1
            }

            echo "✅ CONFIG SAFE"


      - name: Download Packages
        run: |
          cd openwrt
          make download -j$(nproc)

      - name: Compile Firmware
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s

      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt-IPQ807x-CPE-S10
          path: openwrt/bin/targets/ipq807x/


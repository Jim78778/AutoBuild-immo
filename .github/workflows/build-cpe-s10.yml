name: Build Swaiot CPE-S10 ImmortalWrt

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  TZ: Asia/Shanghai
  OPENWRT_DIR: /mnt/openwrt

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. Checkout CI repo
    - name: Checkout CI repo
      uses: actions/checkout@v4

    # 2. Install build dependencies
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils \
          bison build-essential bzip2 ccache clang cmake cpio curl \
          device-tree-compiler flex gawk gettext git gperf help2man \
          intltool libelf-dev libncurses-dev libssl-dev python3 \
          python3-distutils rsync unzip wget zlib1g-dev zstd
        sudo timedatectl set-timezone "$TZ"

    # 3. System resource check
    - name: System resource check
      run: |
        echo "========== CPU =========="
        nproc
        lscpu | grep -E 'Model name|Socket|Thread|Core' || true
        echo
        echo "========== Memory =========="
        free -h
        echo
        echo "========== Disk =========="
        df -h
        echo
        echo "========== /mnt =========="
        ls -lh /mnt || true

    # 4. Clone ImmortalWrt (your fork)
    - name: Clone ImmortalWrt
      run: |
        sudo mkdir -p /mnt
        sudo chown -R $USER:$USER /mnt
        git clone https://github.com/Jim78778/immortalwrt-ipq.git $OPENWRT_DIR
        cd $OPENWRT_DIR
        git checkout Jim78778-patch-1
        ./scripts/getver.sh

    # 5. Verify device & DTS
    - name: Verify S10 device & DTS
      run: |
        cd $OPENWRT_DIR
        grep -R "Device/swaiot_cpe_s10" target/linux/qualcommax/image || exit 1
        test -f target/linux/qualcommax/files/arch/arm64/boot/dts/qcom/ipq8071-s10.dts

    # 6. Add NSS (WWAN) + QModem feeds
    - name: Add NSS & QModem feeds
      run: |
        cd $OPENWRT_DIR

        # QCA NSS / ECM (kernel 6.6, WWAN)
        grep -q '^src-git nss' feeds.conf.default || \
          echo 'src-git nss https://github.com/qosmio/nss-packages.git;NSS-12.5-K6.x-wwan' >> feeds.conf.default

        # QModem
        grep -q '^src-git qmodem' feeds.conf.default || \
          echo 'src-git qmodem https://github.com/FUjr/QModem.git;main' >> feeds.conf.default

        echo "==== feeds.conf.default ===="
        cat feeds.conf.default

    # 7. Update & install feeds
    - name: Update feeds
      run: |
        cd $OPENWRT_DIR
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 8. Generate minimal .config (force S10)
    - name: Generate .config
      run: |
        cd $OPENWRT_DIR
        rm -f .config

        cat > .config << 'EOF'
        CONFIG_TARGET_qualcommax=y
        CONFIG_TARGET_qualcommax_ipq807x=y
        CONFIG_TARGET_qualcommax_ipq807x_DEVICE_swaiot_cpe_s10=y

        CONFIG_DEVEL=y
        CONFIG_CCACHE=y

        # NSS / ECM
        CONFIG_PACKAGE_kmod-qca-nss-dp=y
        CONFIG_PACKAGE_kmod-qca-nss-ecm=y
        CONFIG_PACKAGE_kmod-qca-nss-ecm-ssl=y
        CONFIG_PACKAGE_kmod-qca-nss-ecm-bridge=y
        CONFIG_PACKAGE_kmod-qca-nss-ecm-pppoe=y

        # QModem (按你之前习惯)
        CONFIG_PACKAGE_qmodem=y
        EOF

    # 9. defconfig
    - name: Make defconfig
      run: |
        cd $OPENWRT_DIR
        make defconfig
        grep swaiot_cpe_s10 .config || exit 1
        grep qca-nss .config || true

    # 10. Download sources
    - name: Download packages
      run: |
        cd $OPENWRT_DIR
        make download -j$(nproc)
        find dl -size -1024c -delete

    # 11. Build firmware
    - name: Build firmware
      run: |
        cd $OPENWRT_DIR
        make -j$(nproc) || make -j1 V=s

    # 12. Upload firmware
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: Swaiot-CPE-S10
        path: /mnt/openwrt/bin/targets/qualcommax/ipq807x/*


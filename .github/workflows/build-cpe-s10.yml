name: Build Swaiot CPE-S10 ImmortalWrt (QModem v2.8.0 Stable)

on:
  workflow_dispatch:
  push:
    branches:
      - Jim78778-patch-1

env:
  TZ: Asia/Shanghai
  MAKE_JOBS: 8

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # ===============================
    # 1. Checkout CI repo
    # ===============================
    - name: Checkout CI repository
      uses: actions/checkout@v4

    # ===============================
    # 2. Prepare build environment
    # ===============================
    - name: Setup build environment
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential gcc g++ gawk flex bison \
          gettext libncurses-dev libssl-dev zlib1g-dev \
          file wget curl unzip git rsync python3 python3-distutils \
          ca-certificates ccache bc

        sudo timedatectl set-timezone "$TZ"

    # ===============================
    # 3. Clone ImmortalWrt
    # ===============================
    - name: Clone ImmortalWrt source
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git openwrt
        cd openwrt
        echo "=== ImmortalWrt HEAD ==="
        git log -1 --oneline

    # ===============================
    # 4. Add QModem feed (PIN v2.8.0)
    # ===============================
    - name: Add QModem feed
      run: |
        cd openwrt
        echo "src-git qmodem https://github.com/FUjr/QModem.git;v2.8.0" >> feeds.conf.default
        echo "=== feeds.conf.default (tail) ==="
        tail -n 5 feeds.conf.default

    # ===============================
    # 5. Update & install feeds
    # ===============================
    - name: Update & install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # ===============================
    # 6. Patch QModem deps (ROBUST)
    # ===============================
    - name: Patch QModem dependencies (robust & verified)
      run: |
        cd openwrt

        echo "=== Searching QModem Makefile ==="
        QMODEM_MK=$(find package/feeds -path '*/qmodem/Makefile' | head -n 1)

        if [ -z "$QMODEM_MK" ]; then
          echo "ERROR: qmodem/Makefile not found under package/feeds"
          echo "Available feeds:"
          ls -l package/feeds || true
          exit 1
        fi

        QMODEM_DIR=$(dirname "$QMODEM_MK")
        FEED_DIR=$(dirname "$QMODEM_DIR")

        echo "Using QModem path: $QMODEM_DIR"

        # 主包依赖修正
        sed -i \
          -e 's/kmod-mhi-wwan/kmod-mhi-wwan-mbim kmod-mhi-wwan-ctrl/g' \
          -e 's/quectel-CM-5G//g' \
          "$QMODEM_MK"

        # LuCI 依赖修正（如果存在）
        if [ -f "$FEED_DIR/luci-app-qmodem/Makefile" ]; then
          sed -i \
            -e 's/quectel-CM-5G//g' \
            "$FEED_DIR/luci-app-qmodem/Makefile"
        fi

        echo "=== Patched DEPENDS ==="
        grep DEPENDS "$QMODEM_MK"

    # ===============================
    # 7. Load ci.config
    # ===============================
    - name: Load ci.config
      run: |
        cd openwrt
        cp ../ci.config .config

    # ===============================
    # 8. Force target: Swaiot CPE-S10
    # ===============================
    - name: Force target (CPE-S10, stable)
      run: |
        cd openwrt

        # 清理旧 target
        sed -i '/^CONFIG_TARGET_/d' .config
        sed -i '/^[[:space:]]\+CONFIG_/d' .config

        printf '%s\n' \
          'CONFIG_TARGET_qualcommax=y' \
          'CONFIG_TARGET_qualcommax_ipq807x=y' \
          'CONFIG_TARGET_qualcommax_ipq807x_DEVICE_swaiot_cpe_s10=y' \
          >> .config

        echo "=== Target after force ==="
        grep CONFIG_TARGET_ .config

    # ===============================
    # 9. Make defconfig
    # ===============================
    - name: Make defconfig
      run: |
        cd openwrt
        make defconfig
        echo "=== Final target ==="
        grep CONFIG_TARGET_ .config

    # ===============================
    # 10. Download sources
    # ===============================
    - name: Download packages
      run: |
        cd openwrt
        make download -j$MAKE_JOBS

    # ===============================
    # 11. Build firmware
    # ===============================
    - name: Build firmware
      run: |
        cd openwrt
        make -j$MAKE_JOBS V=sc

    # ===============================
    # 12. Upload artifacts
    # ===============================
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: CPE-S10-firmware
        path: openwrt/bin/targets/
        retention-days: 30

    - name: Upload config
      uses: actions/upload-artifact@v4
      with:
        name: build-config
        path: openwrt/.config


name: Build CPE-S10 ImmortalWrt (kernel-safe)

on:
  workflow_dispatch:
  push:
    branches: [ patch-1 ]

env:
  REPO_URL: https://github.com/Jim78778/immortalwrt-ipq.git
  REPO_BRANCH: Jim78778-patch-1
  CONFIG_FILE: ci.config
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Install deps
      run: |
        sudo apt update
        sudo apt install -y build-essential git gawk gettext \
          libncurses5-dev python3 python3-distutils rsync unzip \
          file wget libelf-dev bc

    - name: Clone source
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt

    - name: Add QModem feed
      run: |
        cd openwrt
        echo "src-git qmodem https://github.com/FUjr/QModem.git" >> feeds.conf.default

    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load config & sanitize
      run: |
        cd openwrt
        cp $GITHUB_WORKSPACE/$CONFIG_FILE .config

        # 固定设备
        sed -i 's/^CONFIG_TARGET_qualcommax_ipq807x_DEVICE_.*/# &/' .config
        echo 'CONFIG_TARGET_qualcommax_ipq807x_DEVICE_cpe_s10=y' >> .config

        # 禁 Rust（防 vendor 炸）
        sed -i 's/^CONFIG_RUST.*/# &/' .config
        sed -i 's/^CONFIG_PACKAGE_rust.*/# &/' .config

        # 移除 ECM / nss-clients
        rm -rf feeds/nss_packages/qca-nss-ecm
        rm -rf feeds/nss_packages/qca-nss-clients

        sed -i 's/^CONFIG_PACKAGE_kmod-qca-nss-ecm.*/# &/' .config
        sed -i 's/^CONFIG_PACKAGE_kmod-qca-nss-clients.*/# &/' .config
        sed -i 's/^CONFIG_ECM_.*/# &/' .config

        # ⭐ 关键三连（顺序不能错）
        make defconfig
        make olddefconfig
        make oldconfig </dev/null

    - name: Download
      run: |
        cd openwrt
        make download -j$(nproc)

    - name: Build
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: CPE-S10-kernel-safe
        path: openwrt/bin/targets/qualcommax/ipq807x/*

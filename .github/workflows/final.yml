name: Merge + Clean Config + Upload

on:
  workflow_dispatch:

env:
  TZ: Asia/Shanghai
  OPENWRT_DIR: openwrt

jobs:
  config:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    # ---- 复制 config 文件，不拷贝整个仓库 ----
    - name: Prepare configs
      run: |
        mkdir -p $OPENWRT_DIR/scripts/kconfig
        cp $GITHUB_WORKSPACE/.config $OPENWRT_DIR/.config.main
        cp $GITHUB_WORKSPACE/ci.config $OPENWRT_DIR/.config.ci

        # 确保 merge_config.sh 在仓库 scripts/kconfig/ 下
        if [ ! -f $OPENWRT_DIR/scripts/kconfig/merge_config.sh ]; then
          echo "ERROR: merge_config.sh not found! Please commit it to scripts/kconfig/"
          exit 1
        fi

    # ---- 合并 config ----
    - name: Merge configs
      run: |
        cd $OPENWRT_DIR
        ./scripts/kconfig/merge_config.sh .config.main .config.ci
        make defconfig

    # ---- 清洗 config ----
    - name: Clean final config
      run: |
        cd $OPENWRT_DIR
        # 删除注释行和空行
        sed -i '/^#.*$/d' .config
        sed -i '/^$/d' .config

        echo "==== Enabled packages count ===="
        grep -c '^CONFIG_PACKAGE_.*=y' .config

        echo "==== Target ===="
        grep '^CONFIG_TARGET_' .config

    # ---- 生成 diff ----
    - name: Generate config diff
      run: |
        cd $OPENWRT_DIR
        diff -u .config.main .config > config.diff || true
        cat config.diff

    # ---- 上传 artifact ----
    - name: Upload final config + diff
      uses: actions/upload-artifact@v4
      with:
        name: final-config
        path: |
          $OPENWRT_DIR/.config
          $OPENWRT_DIR/config.diff

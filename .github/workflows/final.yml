name: Merge + Clean Config + Upload

on:
  workflow_dispatch:

env:
  TZ: Asia/Shanghai
  OPENWRT_DIR: openwrt

jobs:
  config:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    # ---- 复制 config 文件，不拷贝整个仓库 ----
    - name: Prepare configs
      run: |
        mkdir -p $OPENWRT_DIR
        cp $GITHUB_WORKSPACE/.config $OPENWRT_DIR/.config.main
        cp $GITHUB_WORKSPACE/ci.config $OPENWRT_DIR/.config.ci

    # ---- 合并 config ----
    - name: Merge configs
      run: |
        cd $OPENWRT_DIR

        # 如果 merge_config.sh 不存在就下载
        if [ ! -f ./scripts/kconfig/merge_config.sh ]; then
          mkdir -p ./scripts/kconfig
          curl -fsSL https://raw.githubusercontent.com/openwrt/openwrt/master/scripts/kconfig/merge_config.sh -o ./scripts/kconfig/merge_config.sh
          chmod +x ./scripts/kconfig/merge_config.sh
        fi

        ./scripts/kconfig/merge_config.sh .config.main .config.ci
        make defconfig

    # ---- 清洗 config ----
    - name: Clean final config
      run: |
        cd $OPENWRT_DIR
        sed -i '/^#.*$/d' .config
        sed -i '/^$/d' .config

        echo "==== Enabled packages count ===="
        grep -c '^CONFIG_PACKAGE_.*=y' .config

        echo "==== Target ===="
        grep '^CONFIG_TARGET_' .config

    # ---- 生成 diff ----
    - name: Generate config diff
      run: |
        cd $OPENWRT_DIR
        diff -u .config.main .config > config.diff || true
        cat config.diff

    # ---- 上传 artifact ----
    - name: Upload final config + diff
      uses: actions/upload-artifact@v4
      with:
        name: final-config
        path: |
          $OPENWRT_DIR/.config
          $OPENWRT_DIR/config.diff

name: Check DTS Compile (ipq807x)

on:
  workflow_dispatch:
  push:
    branches:
      - swaiot-s10

env:
  TZ: Asia/Shanghai
  OPENWRT_DIR: openwrt

jobs:
  dts-check:
    runs-on: ubuntu-22.04

    steps:
    # 1ï¸âƒ£ æ£€å‡º CI ä»“åº“ï¼ˆworkflow æ‰€åœ¨ä»“åº“ï¼‰
    - name: Checkout CI repo
      uses: actions/checkout@v4

    # 2ï¸âƒ£ é‡Šæ”¾ç£ç›˜ç©ºé—´ï¼ˆéžå¸¸é‡è¦ï¼‰
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        df -h

    # 3ï¸âƒ£ å®‰è£… OpenWrt ç¼–è¯‘ä¾èµ–
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils \
          rsync unzip zlib1g-dev file wget

    # 4ï¸âƒ£ å…‹éš†ä½ çš„ OpenWrt æºç ï¼ˆâš ï¸ ä¸æ˜¯å®˜æ–¹æºï¼‰
    - name: Clone OpenWrt source
      run: |
        git clone https://github.com/Jim78778/immortalwrt-ipq.git openwrt
        cd openwrt
        git checkout swaiot-s10

    # 5ï¸âƒ£ æ›´æ–° feeds
    - name: Update & install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 6ï¸âƒ£ ç”Ÿæˆæœ€å° .configï¼ˆåªä¸º DTS / kernelï¼‰
    - name: Generate minimal config
      run: |
        cd openwrt
        cat > .config <<'EOF'
        CONFIG_TARGET_qualcommax=y
        CONFIG_TARGET_qualcommax_ipq807x=y
        CONFIG_TARGET_qualcommax_ipq807x_DEVICE_swaiot_cpe_s10=y
        CONFIG_KERNEL_BUILD_DOMAIN="buildhost"
        CONFIG_KERNEL_BUILD_USER="builder"
        EOF

        make defconfig

    # 7ï¸âƒ£ ðŸ”¥ çœŸæ­£çš„ DTS éªŒè¯æ­¥éª¤ï¼ˆå…³é”®ï¼‰
    - name: Compile kernel (this runs DTC)
      run: |
        cd openwrt
        make target/linux/compile V=s -j$(nproc)

    # 8ï¸âƒ£ æˆåŠŸæç¤º
    - name: DTS compile result
      run: |
        echo "âœ… DTS successfully compiled via kernel build"

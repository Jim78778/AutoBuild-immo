name: Validate DTS (ipq807x)

on:
  workflow_dispatch:
  push:
    paths:
      - "target/linux/qualcommax/**"
      - ".github/workflows/validate-dts.yml"

env:
  TZ: Asia/Shanghai
  REPO_URL: https://github.com/Jim78778/openwrt-ipq.git
  REPO_BRANCH: swaiot-s10
  OPENWRT_DIR: openwrt

jobs:
  dts-check:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout workflow repo
      uses: actions/checkout@v4

    - name: Set timezone
      run: sudo timedatectl set-timezone "$TZ"

    - name: Install minimal build deps
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          clang \
          flex \
          bison \
          libssl-dev \
          libelf-dev \
          device-tree-compiler \
          python3 \
          rsync \
          unzip \
          file \
          wget

    - name: Clone OpenWrt source
      run: |
        git clone --depth=1 -b "$REPO_BRANCH" "$REPO_URL" "$OPENWRT_DIR"

    - name: Prepare default config
      run: |
        cd "$OPENWRT_DIR"
        make defconfig

    - name: Compile DTS only (kernel target)
      run: |
        cd "$OPENWRT_DIR"
        make target/linux/compile V=s -j$(nproc)

    - name: Check generated DTB
      run: |
        cd "$OPENWRT_DIR"
        echo "===== Generated DTBs ====="
        find build_dir/ -name "*s10*.dtb" || true

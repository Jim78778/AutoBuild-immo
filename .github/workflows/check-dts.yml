name: Check DTS (CPE S10 SKY)

on:
  workflow_dispatch:
  push:
    paths:
      - "target/linux/**/dts/**"
      - ".github/workflows/check-dts.yml"

env:
  TZ: Asia/Shanghai
  OPENWRT_DIR: openwrt
  REPO_URL: https://github.com/Jim78778/openwrt-ipq.git
  REPO_BRANCH: swaiot-s10

jobs:
  check-dts:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout workflow repo
      uses: actions/checkout@v4

    - name: Set timezone
      run: sudo timedatectl set-timezone "$TZ"

    - name: Install minimal dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          device-tree-compiler \
          git

    - name: Clone OpenWrt source
      run: |
        git clone --depth=1 -b "$REPO_BRANCH" "$REPO_URL" "$OPENWRT_DIR"

    - name: Update feeds (dtc headers need this)
      run: |
        cd "$OPENWRT_DIR"
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Build OpenWrt dtc
      run: |
        cd "$OPENWRT_DIR"
        make tools/dtc/compile V=s

    - name: Compile DTS -> DTB (STRICT CHECK)
      run: |
        cd "$OPENWRT_DIR"

        DTS=target/linux/qualcommax/files/arch/arm64/boot/dts/qcom/cpe-s10-sky.dts
        OUT=/tmp/cpe-s10-sky.dtb

        echo "==> Using OpenWrt dtc"
        ./build_dir/host/dtc-*/dtc \
          -Wno-unit_address_vs_reg \
          -I dts -O dtb \
          -o "$OUT" \
          "$DTS"

        echo "==> DTS compiled successfully:"
        ls -lh "$OUT"

    - name: Dump DTB back to DTS (sanity check)
      run: |
        cd "$OPENWRT_DIR"
        ./build_dir/host/dtc-*/dtc \
          -I dtb -O dts \
          /tmp/cpe-s10-sky.dtb \
          > /tmp/cpe-s10-sky.dump.dts

        echo "==> Decompiled DTS head:"
        head -n 40 /tmp/cpe-s10-sky.dump.dts

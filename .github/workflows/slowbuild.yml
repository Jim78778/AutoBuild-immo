name: Swaiot CPE-S10-SKY (ipq807x NSS + QMODEM)

on:
  workflow_dispatch:
  push:
    branches:
      - swaiot-s10

env:
  TZ: Asia/Shanghai

  # OpenWrt source
  REPO_URL: https://github.com/Jim78778/openwrt-ipq.git
  REPO_BRANCH: swaiot-s10

  # Build path (USE GITHUB WORKSPACE, NOT /mnt)
  OPENWRT_DIR: ${{ github.workspace }}

  # Upload
  UPLOAD_FIRMWARE: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    ##########################################################################
    # 1. Maximize disk space (still useful, but not relied on)
    ##########################################################################
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 1024
        temp-reserve-mb: 100
        root-reserve-mb: 1024

    ##########################################################################
    # 2. Checkout workflow repo (this IS the build dir now)
    ##########################################################################
    - name: Checkout workflow repo
      uses: actions/checkout@v4

    ##########################################################################
    # 3. System info (critical for sanity)
    ##########################################################################
    - name: System info
      run: |
        echo "Workspace: $OPENWRT_DIR"
        nproc
        free -h
        df -h
        df -i

    ##########################################################################
    # 4. Init build environment
    ##########################################################################
    - name: Init build environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo timedatectl set-timezone "$TZ"

        sudo rm -rf \
          /usr/share/dotnet \
          /usr/local/lib/android \
          /opt/ghc \
          /opt/hostedtoolcache/CodeQL

        sudo docker image prune -af || true

        sudo apt-get update -y
        sudo apt-get install -y \
          ack antlr3 asciidoc autoconf automake autopoint \
          binutils bison build-essential bzip2 ccache cmake cpio curl \
          device-tree-compiler fastjar flex gawk gettext gcc-multilib \
          g++-multilib git gperf haveged help2man intltool jq \
          libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
          libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev \
          libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp \
          ninja-build p7zip p7zip-full patch pkgconf python-is-python3 \
          python3 python3-pip python3-pyelftools python3-setuptools \
          qemu-utils rsync scons squashfs-tools subversion swig texinfo \
          uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev \
          bc file time xz-utils zstd

        pip3 install pysocks unidecode

    ##########################################################################
    # 5. Clone OpenWrt source INTO workspace
    ##########################################################################
    - name: Clone OpenWrt source
      run: |
        rm -rf ./*
        git clone "$REPO_URL" -b "$REPO_BRANCH" .

    ##########################################################################
    # 6. Update & install feeds
    ##########################################################################
    - name: Update & install feeds
      run: |
        ./scripts/feeds update -a

        ./scripts/feeds install -a -p base
        ./scripts/feeds install -a -p luci
        ./scripts/feeds install -a -p packages
        ./scripts/feeds install -a -p routing
        ./scripts/feeds install -a -p telephony || true

        ./scripts/feeds install -a -p nss_packages || true
        ./scripts/feeds install -a -p qmodem || true

    ##########################################################################
    # 7. Inject QMODEM missing deps (only what qmodem REALLY needs)
    ##########################################################################
    - name: Inject QMODEM dependencies
      run: |
        cd package

        # Quectel-CM-5G (qmodem hard dependency)
        git clone https://github.com/QWRT/quectel-CM-5G.git quectel-CM-5G || true

        # quectel-cm (dependency provider only)
        git clone https://github.com/immortalwrt/packages.git tmp-pkg || true
        cp -r tmp-pkg/net/quectel-cm .
        rm -rf tmp-pkg

    ##########################################################################
    # 8. Patch qmodem Makefile (Linux 6.x MHI split)
    ##########################################################################
    - name: Patch qmodem Makefile
      run: |
        sed -i \
          's/kmod-mhi-wwan/kmod-mhi-bus +kmod-mhi-pci-generic/g' \
          package/feeds/qmodem/qmodem/Makefile || true

    ##########################################################################
    # 9. Make defconfig
    ##########################################################################
    - name: Make defconfig
      run: |
        make defconfig

    ##########################################################################
    # 10. Download sources
    ##########################################################################
    - name: Download sources
      run: |
        make download -j8 || make download -j1 V=s
        find dl -size -1024c -delete

    ##########################################################################
    # 11. Build firmware
    ##########################################################################
    - name: Build firmware
      run: |
        make -j$(nproc) || make -j1 || make -j1 V=s

    ##########################################################################
    # 12. Verify output
    ##########################################################################
    - name: Verify output
      run: |
        ls -lh bin/targets/qualcommax/ipq807x

    ##########################################################################
    # 13. Upload firmware
    ##########################################################################
    - name: Upload firmware
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: Swaiot-CPE-S10-ipq807x-NSS-QMODEM
        path: bin/targets/qualcommax/ipq807x/
        retention-days: 30


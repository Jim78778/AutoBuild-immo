name: 1Swaiot CPE-S10-SKY (ipq807x NSS)

on:
  workflow_dispatch:
  push:
    branches:
      - swaiot-s10

env:
  TZ: Asia/Shanghai

  # Source
  REPO_URL: https://github.com/Jim78778/openwrt-ipq.git
  REPO_BRANCH: swaiot-s10

  # Build config (来自 AutoBuild-immo 仓库)
  CONFIG_FILE: ci.config
  DIY_SCRIPT: diy-part1.sh

  # Paths
  OPENWRT_DIR: /mnt/openwrt-build

  # Switches
  CACHE_TOOLCHAIN: false
  UPLOAD_FIRMWARE: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
   
    ##########################################################################
    # 1. Merge disk space（必须在 apt / clone 之前）
    ##########################################################################
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 1024
        temp-reserve-mb: 100
        root-reserve-mb: 1024

     ##########################################################################
    # 2. Checkout workflow repo（非常关键：否则 ci.config 不存在）
    ##########################################################################
    - name: Checkout workflow repo
      uses: actions/checkout@v4

    
    ##########################################################################
    # 3. Show system info（对齐模板，方便排错）
    ##########################################################################
    - name: Check system info
      run: |
        echo "CPU cores: $(nproc)"
        cat /proc/cpuinfo | grep -m1 "model name" || true
        free -h
        df -hT

    ##########################################################################
    # 4. Init environment（重清理，防止爆盘）
    ##########################################################################
    - name: Init build environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo timedatectl set-timezone "$TZ"

        sudo rm -rf \
          /usr/share/dotnet \
          /usr/local/lib/android \
          /opt/ghc \
          /opt/hostedtoolcache/CodeQL

        sudo docker image prune -af || true

        sudo apt-get update -y
        sudo apt-get install -y \
          ack antlr3 asciidoc autoconf automake autopoint \
          binutils bison build-essential bzip2 ccache cmake cpio curl \
          device-tree-compiler fastjar flex gawk gettext gcc-multilib \
          g++-multilib git gperf haveged help2man intltool jq \
          libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
          libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev \
          libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp \
          ninja-build p7zip p7zip-full patch pkgconf python-is-python3 \
          python3 python3-pip python3-pyelftools python3-setuptools \
          qemu-utils rsync scons squashfs-tools subversion swig texinfo \
          uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev \
          bc file time xz-utils zstd

        sudo apt-get autoremove -y
        sudo apt-get clean

        # feeds 里 python host 工具
        pip3 install pysocks unidecode

    ##########################################################################
    # 5. Prepare /mnt build directory
    ##########################################################################
    - name: Prepare build directory
      run: |
        sudo mkdir -p "$OPENWRT_DIR"
        sudo chown $USER:$USER "$OPENWRT_DIR"
        df -hT /mnt

    ##########################################################################
    # 6. Clone OpenWrt source
    ##########################################################################
    - name: Clone OpenWrt source
      run: |
        git clone "$REPO_URL" -b "$REPO_BRANCH" "$OPENWRT_DIR"
        cd "$OPENWRT_DIR"

        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
        echo "COMMIT_AUTHOR=$(git show -s --format='Author: %an')" >> $GITHUB_ENV
        echo "COMMIT_DATE=$(git show -s --format='Date: %ci')" >> $GITHUB_ENV
        echo "COMMIT_MESSAGE=$(git show -s --format='Message: %s')" >> $GITHUB_ENV
        echo "COMMIT_HASH=$(git show -s --format='Hash: %H')" >> $GITHUB_ENV

    ##########################################################################
    # 7. Copy config & DIY script（已修复路径问题）
    ##########################################################################
    - name: Copy config and diy script
      run: |
        echo "Workspace content:"
        ls -lah "$GITHUB_WORKSPACE"

        test -f "$GITHUB_WORKSPACE/$CONFIG_FILE"
        test -f "$GITHUB_WORKSPACE/$DIY_SCRIPT"

        cp "$GITHUB_WORKSPACE/$CONFIG_FILE" "$OPENWRT_DIR/.config"
        cp "$GITHUB_WORKSPACE/$DIY_SCRIPT" "$OPENWRT_DIR/"
        chmod +x "$OPENWRT_DIR/$DIY_SCRIPT"

    ##########################################################################
    # 8. Update & install feeds
    ##########################################################################
    - name: Update and install feeds
      run: |
        cd "$OPENWRT_DIR"
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    ##########################################################################
    # 9. Run DIY script（只做你定义的轻量动作）
    ##########################################################################
    - name: Run DIY script
      run: |
        cd "$OPENWRT_DIR"
        ./$DIY_SCRIPT

    ##########################################################################
    # 10. Load defconfig
    ##########################################################################
    - name: Make defconfig
      run: |
        cd "$OPENWRT_DIR"
        cp .config .config.before
        make defconfig
        diff -u .config.before .config | head -20 || true

    ##########################################################################
    # 11. Download sources
    ##########################################################################
    - name: Download sources
      run: |
        cd "$OPENWRT_DIR"
        make download -j8
        find dl -size -1024c -delete

    ##########################################################################
    # 12. Build firmware
    ##########################################################################
    - name: Build firmware
      run: |
        cd "$OPENWRT_DIR"
        make -j$(nproc) || make -j1 || make -j1 V=s

    ##########################################################################
    # 13. Verify output
    ##########################################################################
    - name: Verify firmware output
      run: |
        ls -lh "$OPENWRT_DIR/bin/targets/qualcommax/ipq807x"

    ##########################################################################
    # 14. Upload firmware
    ##########################################################################
    - name: Upload firmware
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: Swaiot-CPE-S10-ipq807x-NSS
        path: ${{ env.OPENWRT_DIR }}/bin/targets/qualcommax/ipq807x/
        retention-days: 30

name: immortalwrt (ipq807x s10)

on:
  workflow_dispatch:
  push:
    branches:
      - swaiot-s10

env:
  TZ: Asia/Shanghai
  REPO_URL: https://github.com/Jim78778/openwrt-ipq.git
  REPO_BRANCH: swaiot-s10
  OPENWRT_DIR: ${{ github.workspace }}/openwrt
  UPLOAD_FIRMWARE: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    ##########################################################################
    # 1. Checkout
    ##########################################################################
    - name: Checkout
      uses: actions/checkout@v4

    ##########################################################################
    # 2. Init build environment（CI 必要最小全集）
    ##########################################################################
    - name: Init build environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo timedatectl set-timezone "$TZ"
        sudo apt-get update

        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git \
          libncurses-dev libssl-dev zlib1g-dev \
          python3 python3-distutils python3-pip \
          rsync unzip file wget curl jq \
          ca-certificates

    ##########################################################################
    # 3. Show disk & memory
    ##########################################################################
    - name: Show disk
      run: |
        df -hT
        free -h

    ##########################################################################
    # 4. Clone source
    ##########################################################################
    - name: Clone OpenWrt source
      run: |
        git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" "$OPENWRT_DIR"

    ##########################################################################
    # 5. Update & install feeds（顺序关键）
    ##########################################################################
    - name: Update & install feeds
      run: |
        cd "$OPENWRT_DIR"

        ./scripts/feeds update -a
        ./scripts/feeds install -a -f

        # 先装 host/tools，避免 jq/host、ruby/host 警告
        make tools/install -j$(nproc)
        make toolchain/install -j$(nproc)

    ##########################################################################
    # 6. FIX QMODEM（6.12 + mhi 正确依赖）
    ##########################################################################
    - name: Fix QMODEM dependencies
      run: |
        cd "$OPENWRT_DIR"

        QMF="package/feeds/qmodem/qmodem/Makefile"

        if [ -f "$QMF" ]; then
          echo "== Fixing QMODEM Makefile =="

          sed -i 's/+kmod-mhi-wwan/+kmod-mhi-bus +kmod-mhi-pci-generic +kmod-mhi-wwan-ctrl +kmod-mhi-wwan-mbim/g' "$QMF"
          sed -i '/quectel-cm/d' "$QMF"
          sed -i '/quectel-CM-5G/d' "$QMF"

          sed -i 's/^DEPENDS:=.*/DEPENDS:=+kmod-mhi-bus +kmod-mhi-pci-generic +kmod-mhi-wwan-ctrl +kmod-mhi-wwan-mbim +kmod-usb-net +kmod-usb-net-qmi-wwan +kmod-usb-net-cdc-mbim +uqmi +umbim +libubus +libuci/' "$QMF"

          grep DEPENDS "$QMF"
        else
          echo "QMODEM not found, skip patch"
        fi

    ##########################################################################
    # 7. Load config（只选包，不碰 kernel）
    ##########################################################################
    - name: Load config
      run: |
        cd "$OPENWRT_DIR"

        cat > .config << 'EOF'
        CONFIG_TARGET_qualcommax=y
        CONFIG_TARGET_qualcommax_ipq807x=y
        CONFIG_TARGET_qualcommax_ipq807x_DEVICE_swaiot_cpe_s10=y

        CONFIG_ARCH_64BIT=y
        CONFIG_aarch64=y
        CONFIG_LINUX_6_12=y

        # 避免已知问题包
        # CONFIG_PACKAGE_luci-app-advanced-reboot is not set
        # CONFIG_PACKAGE_onionshare-cli is not set

        # qmodem
        CONFIG_PACKAGE_qmodem=y

        # Netfilter（只选 kmod，不写 CONFIG_KERNEL）
        CONFIG_PACKAGE_kmod-nf-conntrack=y
        CONFIG_PACKAGE_kmod-nf-conntrack-netlink=y
        CONFIG_PACKAGE_kmod-nf-log=y
        CONFIG_PACKAGE_kmod-nfnetlink=y
        EOF

        make defconfig
        make olddefconfig
        make target/linux/olddefconfig

    ##########################################################################
    # 8. Download sources
    ##########################################################################
    - name: Download sources
      run: |
        cd "$OPENWRT_DIR"
        make download -j8 || make download -j1 V=s
        find dl -size -1024c -delete

    ##########################################################################
    # 9. Build firmware
    ##########################################################################
    - name: Build firmware
      run: |
        cd "$OPENWRT_DIR"
        make -j$(nproc) || make -j1 V=s

    ##########################################################################
    # 10. Upload firmware
    ##########################################################################
    - name: Upload firmware
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-ipq807x-s10
        path: openwrt/bin/targets/
        retention-days: 30

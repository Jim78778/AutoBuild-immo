name: Build Swaiot CPE-S10 (ipq807x NSS)

on:
  workflow_dispatch:
  push:
    branches:
      - swaiot-s10
    paths:
      - 'ci.config'
      - 'diy-part1.sh'
      - '.github/workflows/**'

env:
  TZ: Asia/Shanghai
  REPO_URL: https://github.com/Jim78778/openwrt-ipq.git
  REPO_BRANCH: swaiot-s10
  CONFIG_FILE: ci.config
  DIY_SCRIPT: diy-part1.sh
  OPENWRT_DIR: /mnt/openwrt
  UPLOAD_FIRMWARE: true

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    # ------------------------------------------------------------
    # 1. Checkout workflow repo
    # ------------------------------------------------------------
    - name: Checkout workflow repo
      uses: actions/checkout@v4

    # ------------------------------------------------------------
    # 2. Set timezone
    # ------------------------------------------------------------
    - name: Set timezone
      run: sudo timedatectl set-timezone "$TZ"

    # ------------------------------------------------------------
    # 3. Aggressive disk cleanup (SAFE MODE)
    # ------------------------------------------------------------
    - name: Free disk space
      run: |
        echo "=== Disk before cleanup ==="
        df -h

        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/local/go
        sudo rm -rf /usr/share/swift
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache
        sudo rm -rf /usr/local/lib/node_modules
        sudo rm -rf /usr/local/aws-cli
        sudo rm -rf /usr/local/aws-sam-cli
        sudo docker image prune -af || true

        sudo apt-get clean
        sudo apt-get autoremove -y

        sudo rm -rf /tmp/*
        sudo rm -rf /var/tmp/*

        echo "=== Disk after cleanup ==="
        df -h

    # ------------------------------------------------------------
    # 4. Install OpenWrt build dependencies
    # ------------------------------------------------------------
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison \
          build-essential bzip2 ccache clang cmake cpio curl \
          device-tree-compiler ecj fastjar flex gawk gettext \
          gcc g++ gcc-12 g++-12 gcc-multilib g++-multilib \
          git gperf haveged help2man intltool jq lib32gcc-s1 libc6-dev-i386 \
          libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev \
          libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev \
          libssl-dev libtool lld lrzsz mkisofs msmtp nano ninja-build \
          p7zip p7zip-full patch pkgconf python-is-python3 python3 python3-pip \
          python3-ply python3-docutils python3-setuptools python3-wheel \
          qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo \
          uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev bc file time \
          xz-utils zstd liblzma-dev libzstd-dev libstdc++-12-dev libcap-dev \
          libnl-3-dev libnl-genl-3-dev

        # feeds 中 python 工具的 host 依赖（不影响 target）
        pip3 install pysocks unidecode
    # ------------------------------------------------------------
    # 5. Prepare /mnt build dir
    # ------------------------------------------------------------
    - name: Prepare build directory
      run: |
        sudo mkdir -p "$OPENWRT_DIR"
        sudo chown $USER:$USER "$OPENWRT_DIR"
        df -h /mnt

    # ------------------------------------------------------------
    # 6. Clone OpenWrt source
    # ------------------------------------------------------------
    - name: Clone OpenWrt source
      run: |
        git clone --depth=1 -b "$REPO_BRANCH" "$REPO_URL" "$OPENWRT_DIR"
        df -h

    # ------------------------------------------------------------
    # 7. Fix feeds.conf.default (REMOVE video feed)
    # ------------------------------------------------------------
    - name: Fix feeds
      run: |
        cd "$OPENWRT_DIR"

        sed -i '/^src-git video/d' feeds.conf.default

        cat feeds.conf.default

    # ------------------------------------------------------------
    # 8. Copy config & DIY script
    # ------------------------------------------------------------
    - name: Copy config and DIY script
      run: |
        cp "${{ github.workspace }}/$CONFIG_FILE" "$OPENWRT_DIR/.config"
        cp "${{ github.workspace }}/$DIY_SCRIPT" "$OPENWRT_DIR/"
        chmod +x "$OPENWRT_DIR/$DIY_SCRIPT"

    # ------------------------------------------------------------
    # 9. Update & install feeds (NO video)
    # ------------------------------------------------------------
    - name: Update feeds
      run: |
        cd "$OPENWRT_DIR"
        ./scripts/feeds update base packages luci routing telephony nss_packages sqm_scripts_nss
        ./scripts/feeds install -a

    # ------------------------------------------------------------
    # 10. Apply DIY script
    # ------------------------------------------------------------
    - name: Apply diy-part1.sh
      run: |
        cd "$OPENWRT_DIR"
        ./$DIY_SCRIPT

    # ------------------------------------------------------------
    # 11. Defconfig + sanity check
    # ------------------------------------------------------------
    - name: Load config
      run: |
        cd "$OPENWRT_DIR"
        make defconfig

        grep -q "CONFIG_TARGET_qualcommax_ipq807x_DEVICE_swaiot_cpe_s10=y" .config

    # ------------------------------------------------------------
    # 12. Download sources (retry)
    # ------------------------------------------------------------
    - name: Download packages
      run: |
        cd "$OPENWRT_DIR"
        make download -j1 || make download -j1

    # ------------------------------------------------------------
    # 13. Build firmware
    # ------------------------------------------------------------
    - name: Build firmware
      run: |
        cd "$OPENWRT_DIR"
        make -j1 V=s

    # ------------------------------------------------------------
    # 14. Verify firmware
    # ------------------------------------------------------------
    - name: Verify firmware files
      run: |
        cd "$OPENWRT_DIR"
        ls -lh bin/targets/qualcommax/ipq807x/
        find bin/targets/qualcommax/ipq807x -name "*.bin" -o -name "*.ubi" -o -name "*.itb"

    # ------------------------------------------------------------
    # 15. Upload firmware
    # ------------------------------------------------------------
    - name: Upload firmware
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: Swaiot-CPE-S10-ipq807x-NSS
        path: ${{ env.OPENWRT_DIR }}/bin/targets/qualcommax/ipq807x/
        retention-days: 30

name: Build Swaiot CPE-S10 OpenWrt

on:
  workflow_dispatch:
  push:
    branches:
      - swaiot-s10

env:
  TZ: Asia/Shanghai
  REPO_URL: https://github.com/Jim78778/openwrt-ipq.git
  REPO_BRANCH: swaiot-s10
  CONFIG_FILE: ci.config
  FEEDS_CONF: feeds.conf.default
  UPLOAD_FIRMWARE: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. Checkout repo
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        repository: Jim78778/openwrt-ipq
        ref: swaiot-s10

    # 2. Set timezone
    - name: Set Timezone
      run: sudo timedatectl set-timezone "$TZ"

    # 3. Install build dependencies
    - name: Install Build Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential binutils bzip2 diffutils findutils flex gawk \
          gcc git gettext libncurses5-dev libz-dev libc6-dev make perl python3 rsync \
          subversion unzip wget which time

    # 4. Prepare feeds (includes QModem)
    - name: Update & Install Feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 5. Copy ci.config
    - name: Copy ci.config
      run: cp ${{ env.CONFIG_FILE }} .config

    # 6. Build firmware
    - name: Build Firmware
      run: |
        make defconfig
        make -j$(nproc) V=s

    # 7. Upload artifacts
    - name: Upload Firmware Artifacts
      if: ${{ env.UPLOAD_FIRMWARE == 'true' }}
      uses: actions/upload-artifact@v3
      with:
        name: Swaiot-CPE-S10-Firmware
        path: bin/targets/qualcommax/ipq807x/

nname: Build Swaiot CPE-S10 (ipq807x NSS) - STABLE

on:
  workflow_dispatch:
  push:
    branches:
      - swaiot-s10

env:
  TZ: Asia/Shanghai
  REPO_URL: https://github.com/Jim78778/openwrt-ipq.git
  REPO_BRANCH: swaiot-s10
  CONFIG_FILE: ci.config
  DIY_SCRIPT: diy-part1.sh
  OPENWRT_DIR: /mnt/openwrt

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1ï¸âƒ£ Checkout workflow repo
    - name: Checkout workflow repo
      uses: actions/checkout@v4

    # 2ï¸âƒ£ Install minimal build dependencies
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex bison gawk gettext \
          git libncurses-dev libssl-dev python3 rsync unzip \
          file wget time bc zstd xz-utils

    # 3ï¸âƒ£ Prepare build directory
    - name: Prepare build directory
      run: |
        sudo mkdir -p "$OPENWRT_DIR"
        sudo chown $USER:$USER "$OPENWRT_DIR"

    # 4ï¸âƒ£ Clone OpenWrt source
    - name: Clone openwrt-ipq
      run: |
        git clone --depth=1 -b "$REPO_BRANCH" "$REPO_URL" "$OPENWRT_DIR"

    # 5ï¸âƒ£ Copy config & DIY script
    - name: Copy config and DIY script
      run: |
        cp "$CONFIG_FILE" "$OPENWRT_DIR/.config"
        cp "$DIY_SCRIPT" "$OPENWRT_DIR/"
        chmod +x "$OPENWRT_DIR/$DIY_SCRIPT"

    # 6ï¸âƒ£ Update & install feeds
    - name: Update feeds
      run: |
        cd "$OPENWRT_DIR"
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 7ï¸âƒ£ Apply DIY script
    - name: Apply DIY script
      run: |
        cd "$OPENWRT_DIR"
        ./$DIY_SCRIPT

    # 8ï¸âƒ£ Sanitize config (CRITICAL)
    - name: Sanitize .config
      run: |
        cd "$OPENWRT_DIR"

        echo "ðŸ§¹ æ¸…ç†å·²çŸ¥é—®é¢˜åŒ…é…ç½®"

        sed -i '
          /^CONFIG_PACKAGE_qmodem=/d
          /^CONFIG_PACKAGE_gst1-plugins-base=/d
          /^CONFIG_PACKAGE_onionshare-cli=/d
        ' .config

        cat >> .config <<'EOF'
        # å¼ºåˆ¶ç¦ç”¨é—®é¢˜åŒ…
        # CONFIG_PACKAGE_qmodem is not set
        # CONFIG_PACKAGE_gst1-plugins-base is not set
        # CONFIG_PACKAGE_onionshare-cli is not set

        # å¼ºåˆ¶å¯ç”¨ SquashFS
        CONFIG_TARGET_ROOTFS_SQUASHFS=y
        EOF

    # 9ï¸âƒ£ Generate final config
    - name: olddefconfig
      run: |
        cd "$OPENWRT_DIR"
        make olddefconfig || {
          echo "âŒ olddefconfig failed"
          exit 1
        }

    # ðŸ”Ÿ Assert SquashFS
    - name: Assert SquashFS
      run: |
        cd "$OPENWRT_DIR"
        grep CONFIG_TARGET_ROOTFS_SQUASHFS=y .config || {
          echo "âŒ SquashFS æœªå¯ç”¨"
          exit 1
        }

    # 1ï¸âƒ£1ï¸âƒ£ Download sources
    - name: Download packages
      run: |
        cd "$OPENWRT_DIR"
        make download -j1 V=s

    # 1ï¸âƒ£2ï¸âƒ£ Build firmware
    - name: Build firmware
      run: |
        cd "$OPENWRT_DIR"
        make -j$(($(nproc)/2)) V=s || make -j1 V=s

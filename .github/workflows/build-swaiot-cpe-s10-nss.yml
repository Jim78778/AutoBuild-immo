name: Build Swaiot CPE-S10 (openwrt-ipq NSS)

on:
  workflow_dispatch:
  push:
    branches:
      - swaiot-s10

env:
  TZ: Asia/Shanghai
  OPENWRT_DIR: /mnt/openwrt

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. Checkout CI repo (ci.config)
    - name: Checkout CI repo
      uses: actions/checkout@v4

    # 2. System info
    - name: System info
      run: |
        echo "CPU:" && nproc
        lscpu | grep -E 'Model name|Core'
        echo "Memory:" && free -h
        echo "Disk:" && df -hT

    # 3. Cleanup environment
    - name: Cleanup environment
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo docker image prune -af || true
        df -hT

    # 4. Install build dependencies
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          autoconf automake autopoint bc bison bzip2 ccache clang cmake \
          coreutils curl diffutils findutils file flex gawk gettext git gperf help2man \
          intltool jq libelf-dev libncurses-dev libssl-dev lua5.3 \
          patch perl python3 python3-distutils rsync subversion unzip wget \
          zlib1g-dev zstd
        sudo timedatectl set-timezone "$TZ"

        # 清理可能的 host 构建缓存
        rm -rf $OPENWRT_DIR/staging_dir/host
        rm -rf $OPENWRT_DIR/build_dir/hostpkg

    # 5. Prepare /mnt
    - name: Prepare workspace
      run: |
        sudo mkdir -p /mnt
        sudo chown -R $USER:$USER /mnt

    # 6. Clone openwrt-ipq fork
    - name: Clone openwrt-ipq fork
      run: |
        git clone -b swaiot-s10 https://github.com/Jim78778/openwrt-ipq.git $OPENWRT_DIR
        cd $OPENWRT_DIR
        ./scripts/getver.sh

    # 7. Fix NSS feed / patch ECM if needed
    - name: Fix NSS dependencies and patch ECM
  run: |
    cd $OPENWRT_DIR

    echo "Fixing nss_packages feed..."

    # 1️⃣ 清理并替换 nss_packages feed（防止重复）
    cp feeds.conf.default feeds.conf.default.backup || true
    sed -i '/^src-git nss_packages/d' feeds.conf.default
    echo 'src-git nss_packages https://github.com/openwrt/nss-packages.git;master' >> feeds.conf.default

    # 2️⃣ 更新 feeds
    ./scripts/feeds update nss_packages
    ./scripts/feeds install -a -p nss_packages -f

    # 3️⃣ 如果缺失 rmnet 符号，给 ECM 打兜底 patch
    SYMBOL="nss_rmnet_rx_get_ifnum"
    if ! grep -rq "$SYMBOL" feeds/nss_packages/qca-nss-drv; then
      echo "WARNING: $SYMBOL not found, patching ECM..."

      cat > /tmp/fix_rmnet_symbol.patch << 'EOF'
--- a/ecm_interface.c
+++ b/ecm_interface.c
@@ -1234,7 +1234,13 @@ static int ecm_interface_rmnet_event(struct notifier_block *nb,
 #ifdef ECM_INTERFACE_RMNET_ENABLE
 static int ecm_interface_rmnet_rx_event(struct sk_buff *skb, struct net_device *dev)
 {
+#if defined(nss_rmnet_rx_get_interface_number)
+    int ifnum = nss_rmnet_rx_get_interface_number(skb);
+#elif defined(nss_rmnet_rx_get_ifnum)
     int ifnum = nss_rmnet_rx_get_ifnum(skb);
+#else
+    return NOTIFY_DONE;
+#endif

     if (ifnum < 0) {
         return NOTIFY_DONE;
EOF

      if [ -f feeds/nss_packages/qca-nss-ecm/src/ecm_interface.c ]; then
        patch -p1 -d feeds/nss_packages/qca-nss-ecm/src < /tmp/fix_rmnet_symbol.patch || true
      fi
    fi



    # 8. Verify target base
    - name: Verify qualcommax target
      run: |
        cd $OPENWRT_DIR
        ls target/linux/qualcommax >/dev/null

    # 9. Add QModem feed
    - name: Add QModem feed
      run: |
        cd $OPENWRT_DIR
        grep -q '^src-git qmodem' feeds.conf.default || \
          echo 'src-git qmodem https://github.com/FUjr/QModem.git;main' >> feeds.conf.default

    # 10. Update & install feeds
    - name: Update feeds
      run: |
        cd $OPENWRT_DIR
        ./scripts/feeds update -a
        ./scripts/feeds install -a -f

    # 11. Apply ci.config
    - name: Apply ci.config
      run: |
        cd $OPENWRT_DIR
        test -f "$GITHUB_WORKSPACE/ci.config" || exit 1
        cat "$GITHUB_WORKSPACE/ci.config" >> .config

    # 12. Force Swaiot CPE-S10 + NSS options
    - name: Force target & NSS options
      run: |
        cd $OPENWRT_DIR
        sed -i '/^CONFIG_TARGET_/d' .config
        sed -i '/^CONFIG_PACKAGE_qca-nss-ecm/d' .config
        cat >> .config << 'EOF'
        CONFIG_TARGET_qualcommax=y
        CONFIG_TARGET_qualcommax_ipq807x=y
        CONFIG_TARGET_qualcommax_ipq807x_DEVICE_swaiot_cpe_s10=y
        CONFIG_QCA_NSS_DP=y
        CONFIG_QCA_NSS_DRV=y
        CONFIG_DEVEL=y
        CONFIG_CCACHE=y
        EOF

    # 13. Make defconfig
    - name: Make defconfig
      run: |
        cd $OPENWRT_DIR
        make defconfig
        grep swaiot_cpe_s10 .config || exit 1
        echo "NSS相关配置状态:"
        grep -E "NSS|nss|ECM" .config || true

    # 14. Download sources
    - name: Download packages
      run: |
        cd $OPENWRT_DIR
        make download -j$(nproc)
        find dl -size -1024c -delete

    # 15. Build NSS drv & DP
    - name: Build NSS drv & DP
      run: |
        cd $OPENWRT_DIR
        make package/feeds/nss_packages/qca-nss-drv/compile -j$(nproc) V=s
        make package/feeds/nss_packages/qca-nss-dp/compile -j$(nproc) V=s

    # 16. Build NSS ECM (optional,不会挂掉)
    - name: Build NSS ECM (optional)
      run: |
        cd $OPENWRT_DIR
        make package/feeds/nss_packages/qca-nss-ecm/compile -j1 V=s 2>&1 | tee /tmp/ecm_build.log || {
          echo "ECM构建失败，继续构建其他部分..."
        }

    # 17. Build full firmware
    - name: Build full firmware
      run: |
        cd $OPENWRT_DIR
        make -j$(nproc) V=s 2>&1 | tee /tmp/full_build.log || {
          echo "尝试单线程构建..."
          make -j1 V=s 2>&1 | tee /tmp/single_build.log || exit 1
        }

    # 18. Upload firmware artifacts
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: Swaiot-CPE-S10-NSS
        path: $OPENWRT_DIR/bin/targets/qualcommax/ipq807x/*
        if-no-files-found: error

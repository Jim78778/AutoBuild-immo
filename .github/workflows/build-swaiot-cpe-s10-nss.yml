name: Build Swaiot CPE-S10 (ipq807x NSS)

on:
  workflow_dispatch:
  push:
    branches:
      - swaiot-s10

env:
  TZ: Asia/Shanghai
  REPO_URL: https://github.com/Jim78778/openwrt-ipq.git
  REPO_BRANCH: swaiot-s10
  CONFIG_FILE: ci.config
  DIY_SCRIPT: diy-part1.sh
  UPLOAD_FIRMWARE: true
  OPENWRT_DIR: /mnt/openwrt-build

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # ===============================
    # 1. Checkout workflow repo
    # ===============================
    - name: Checkout workflow repo
      uses: actions/checkout@v4

    # ===============================
    # 2. Set timezone
    # ===============================
    - name: Set timezone
      run: sudo timedatectl set-timezone "$TZ"

    # ===============================
    # 3. Free disk space
    # ===============================
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt-get clean

    # ===============================
    # 4. Install build dependencies
    # ===============================
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison \
          build-essential bzip2 ccache clang cmake cpio curl \
          device-tree-compiler ecj fastjar flex gawk gettext \
          gcc g++ gcc-12 g++-12 \
          gcc-multilib g++-multilib git gperf haveged help2man \
          intltool jq lib32gcc-s1 libc6-dev-i386 libelf-dev \
          libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev \
          libmpfr-dev libncurses5-dev libncursesw5-dev \
          libreadline-dev libssl-dev libtool lld lrzsz \
          mkisofs msmtp nano ninja-build p7zip p7zip-full \
          patch pkgconf python-is-python3 \
          python3 python3-pip python3-ply python3-socks \
          python3-docutils python3-unidecode \
          python3-setuptools python3-wheel \
          qemu-utils re2c rsync scons \
          squashfs-tools subversion swig texinfo uglifyjs \
          upx-ucl unzip vim wget xmlto xxd zlib1g-dev \
          bc file time xz-utils zstd \
          liblzma-dev libzstd-dev libstdc++-12-dev \
          libcap-dev libnl-3-dev libnl-genl-3-dev

    # ===============================
    # 5. Prepare build directory
    # ===============================
    - name: Prepare /mnt build directory
      run: |
        sudo mkdir -p $OPENWRT_DIR
        sudo chown $USER:$USER $OPENWRT_DIR

    # ===============================
    # 6. Clone openwrt-ipq source
    # ===============================
    - name: Clone openwrt-ipq
      run: |
        git clone --depth=1 -b $REPO_BRANCH $REPO_URL $OPENWRT_DIR

    # ===============================
    # 7. Copy ci.config and diy script
    # ===============================
    - name: Copy configs and DIY script
      run: |
        cp ${{ github.workspace }}/$CONFIG_FILE $OPENWRT_DIR/.config
        cp ${{ github.workspace }}/$DIY_SCRIPT $OPENWRT_DIR/

    # ===============================
    # 8. Update & install feeds
    # ===============================
    - name: Update & install feeds
      run: |
        cd $OPENWRT_DIR
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # ===============================
    # 9. Pre-cache qca-nss-drv source (CRITICAL)
    # ===============================
    - name: Pre-cache qca-nss-drv source
      run: |
        set -e
        cd $OPENWRT_DIR
        mkdir -p dl

        [ -d dl/qca-nss-drv ] || \
          git clone --depth=1 https://github.com/Jim78778/qca-nss-drv.git dl/qca-nss-drv

        cd dl
        tar -czf qca-nss-drv-preload.tar.gz qca-nss-drv
        ls -lh qca-nss-drv-preload.tar.gz

    # ===============================
    # 10. Patch qca-nss-drv Makefile to use local cache
    # ===============================
    - name: Patch qca-nss-drv Makefile
      run: |
        cd $OPENWRT_DIR
        sed -i \
          -e 's#^PKG_SOURCE_PROTO:=.*##' \
          -e 's#^PKG_SOURCE_URL:=.*#PKG_SOURCE_URL:=file://$(TOPDIR)/dl#' \
          -e 's#^PKG_SOURCE_VERSION:=.*##' \
          package/feeds/nss_packages/qca-nss-drv/Makefile

        grep -q '^PKG_SOURCE:=' package/feeds/nss_packages/qca-nss-drv/Makefile || \
          sed -i '1i PKG_SOURCE:=qca-nss-drv-preload.tar.gz\nPKG_HASH:=skip\n' \
          package/feeds/nss_packages/qca-nss-drv/Makefile

    # ===============================
    # 11. Apply diy-part1.sh (QModem / NSS tweaks)
    # ===============================
    - name: Apply diy-part1.sh
      run: |
        cd $OPENWRT_DIR
        chmod +x $DIY_SCRIPT
        ./$DIY_SCRIPT

    # ===============================
    # 12. Load config
    # ===============================
    - name: Load ci.config
      run: |
        cd $OPENWRT_DIR
        make defconfig

    # ===============================
    # 13. Download all sources (stable)
    # ===============================
    - name: Download packages
      run: |
        cd $OPENWRT_DIR
        make download -j1 V=s

    # ===============================
    # 14. Build firmware
    # ===============================
    - name: Build firmware
      run: |
        cd $OPENWRT_DIR
        make -j$(nproc) V=s

    # ===============================
    # 15. Upload firmware
    # ===============================
    - name: Upload firmware
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: Swaiot-CPE-S10-ipq807x-NSS
        path: $OPENWRT_DIR/bin/targets/qualcommax/ipq807x/

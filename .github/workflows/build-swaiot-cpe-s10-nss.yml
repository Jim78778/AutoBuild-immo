name: Build Swaiot CPE-S10 (ipq807x NSS)

on:
  workflow_dispatch:
  push:
    branches:
      - swaiot-s10

env:
  TZ: Asia/Shanghai
  REPO_URL: https://github.com/Jim78778/openwrt-ipq.git
  REPO_BRANCH: swaiot-s10
  CONFIG_FILE: ci.config
  DIY_SCRIPT: diy-part1.sh
  UPLOAD_FIRMWARE: true
  OPENWRT_DIR: /mnt/openwrt-build

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. Checkout workflow repo
    - name: Checkout workflow repo
      uses: actions/checkout@v4

    # 2. Set timezone
    - name: Set timezone
      run: sudo timedatectl set-timezone "$TZ"

    # 3. Free disk space
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt-get clean
        df -h

    # 4. Install build dependencies + NSS host deps
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison \
          build-essential bzip2 ccache clang cmake cpio curl \
          device-tree-compiler ecj fastjar flex gawk gettext \
          gcc g++ gcc-12 g++-12 gcc-multilib g++-multilib \
          git gperf haveged help2man intltool jq lib32gcc-s1 libc6-dev-i386 \
          libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev \
          libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev \
          libssl-dev libtool lld lrzsz mkisofs msmtp nano ninja-build \
          p7zip p7zip-full patch pkgconf python-is-python3 python3 python3-pip \
          python3-ply python3-docutils python3-setuptools python3-wheel \
          qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo \
          uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev bc file time \
          xz-utils zstd liblzma-dev libzstd-dev libstdc++-12-dev libcap-dev \
          libnl-3-dev libnl-genl-3-dev

        # å®‰è£… NSS ç¼ºå¤±çš„ä¸»æœºä¾èµ–
        pip3 install pysocks unidecode

    # 5. Prepare /mnt build directory
    - name: Prepare /mnt build directory
      run: |
        sudo mkdir -p "$OPENWRT_DIR"
        sudo chown $USER:$USER "$OPENWRT_DIR"
        df -h /mnt

    # 6. Clone openwrt-ipq source
    - name: Clone openwrt-ipq
      run: |
        git clone --depth=1 -b "$REPO_BRANCH" "$REPO_URL" "$OPENWRT_DIR"

    # 7. Copy ci.config and diy script
    - name: Copy configs and DIY script
      run: |
        cp "${{ github.workspace }}/$CONFIG_FILE" "$OPENWRT_DIR/.config"
        cp "${{ github.workspace }}/$DIY_SCRIPT" "$OPENWRT_DIR/"
        chmod +x "$OPENWRT_DIR/$DIY_SCRIPT"

    # 8. Update & install feeds
    - name: Update & install feeds
      run: |
        cd "$OPENWRT_DIR"
        ./scripts/feeds update -a
        ./scripts/feeds install -a -f -p qmodem

    # 9. å…³é”®ï¼šæ˜ç¡® NSS é…ç½®æ¨¡å¼
    - name: Configure NSS mode
      run: |
        cd "$OPENWRT_DIR"
        
        echo "========================================="
        echo "  ğŸ¯ æ˜ç¡® NSS é…ç½®æ¨¡å¼"
        echo "========================================="
        
        # æ£€æŸ¥å½“å‰é…ç½®
        echo "å½“å‰ .config ä¸­çš„ NSS ç›¸å…³é…ç½®:"
        grep -E "CONFIG_PACKAGE.*NSS|CONFIG_PACKAGE.*nss" .config || echo "æœªæ‰¾åˆ° NSS é…ç½®"
        
        echo ""
        echo "ğŸ“‹ NSS æ¨¡å¼è¯´æ˜:"
        echo "1. WWAN-only NSS: NSS ä»…å¤„ç†èœ‚çªç½‘ç»œåŠ é€Ÿ"
        echo "2. WiFi NSS: NSS å¤„ç† WiFi åŠ é€Ÿ (ä¸ mac80211 å†²çª)"
        echo "3. å…¨åŠŸèƒ½ NSS: åŒ…å«æ‰€æœ‰ NSS æ¨¡å—"
        echo ""
        echo "âš ï¸ é‡è¦: WiFi NSS ä¸ mac80211 æ— çº¿é©±åŠ¨ä¸å…¼å®¹"
        echo "å¦‚æœé€‰æ‹© WiFi NSSï¼Œå¿…é¡»ç¦ç”¨ mac80211"
        
        # æ ¹æ® diy-part1.sh å†…å®¹å†³å®šé…ç½®
        echo ""
        echo "æ£€æŸ¥ DIY è„šæœ¬å†…å®¹..."
        if grep -q "ç²¾ç®€ NSS.*åªä¿ç•™ WWAN" "$DIY_SCRIPT"; then
          echo "âœ… DIY è„šæœ¬é…ç½®: WWAN-only NSS"
        elif grep -q "ç²¾ç®€ NSS.*åªä¿ç•™ WiFi" "$DIY_SCRIPT"; then
          echo "âœ… DIY è„šæœ¬é…ç½®: WiFi NSS"
          echo "âš ï¸ è­¦å‘Š: WiFi NSS å¯èƒ½ä¸ mac80211 å†²çª"
        else
          echo "â„¹ï¸ DIY è„šæœ¬æœªæ˜ç¡®æŒ‡å®š NSS æ¨¡å¼"
        fi

    # 10. Apply diy-part1.sh (æ˜ç¡®é…ç½® NSS æ¨¡å¼)
    - name: Apply diy-part1.sh
      run: |
        cd "$OPENWRT_DIR"
        chmod +x "$DIY_SCRIPT"
        echo "æ‰§è¡Œ DIY è„šæœ¬..."
        ./$DIY_SCRIPT
        
        # æ£€æŸ¥æ‰§è¡Œåé…ç½®
        echo ""
        echo "DIY è„šæœ¬æ‰§è¡Œåæ£€æŸ¥:"
        echo "1. NSS é©±åŠ¨é…ç½®:"
        grep "CONFIG_PACKAGE_kmod-qca-nss-drv" .config || echo "æœªæ‰¾åˆ° NSS é©±åŠ¨é…ç½®"
        
        echo ""
        echo "2. æ— çº¿é©±åŠ¨é…ç½®:"
        grep "CONFIG_PACKAGE_kmod-mac80211\|CONFIG_PACKAGE_kmod-ath" .config || echo "æœªæ‰¾åˆ°æ— çº¿é©±åŠ¨é…ç½®"
        
        echo ""
        echo "3. æ£€æŸ¥å†²çªé…ç½®:"
        if grep -q "CONFIG_PACKAGE_kmod-qca-nss-drv-wifi-meshmgr=y" .config && \
           grep -q "CONFIG_PACKAGE_kmod-mac80211=y" .config; then
          echo "âŒ æ£€æµ‹åˆ°å†²çªé…ç½®: WiFi NSS å’Œ mac80211 åŒæ—¶å¯ç”¨"
          echo "   è¿™å¯èƒ½å¯¼è‡´æ„å»ºå¤±è´¥æˆ–åŠŸèƒ½å¼‚å¸¸"
          # å¯ä»¥é€‰æ‹©åœ¨æ­¤å¤„è‡ªåŠ¨ä¿®å¤æˆ–æŠ¥é”™é€€å‡º
          # exit 1
        else
          echo "âœ… æœªæ£€æµ‹åˆ°æ˜æ˜¾é…ç½®å†²çª"
        fi

    # 11. Load config (å®‰å…¨çš„åšæ³•)
    - name: Load config
      run: |
        cd "$OPENWRT_DIR"
        echo "ç”Ÿæˆæœ€ç»ˆé…ç½®..."
        
        # ä¿å­˜é…ç½®å‰çš„çŠ¶æ€
        cp .config .config.before_defconfig
        
        # æ‰§è¡Œ defconfigï¼Œä¸å¿½ç•¥é”™è¯¯
        make defconfig
        
        # æ¯”è¾ƒé…ç½®å˜åŒ–
        echo ""
        echo "é…ç½®å˜åŒ–å¯¹æ¯”:"
        diff -u .config.before_defconfig .config | grep -E "^[+-]" | grep -v "^---\|^+++" | head -20 || true

    # 12. Debug NSS config (åªæ˜¾ç¤ºä¿ç•™æ¨¡å—)
    - name: Debug NSS config
      run: |
        cd "$OPENWRT_DIR"
        echo "===== æœ€ç»ˆ NSS / qca-nss é…ç½® ====="
        grep -E "CONFIG_PACKAGE.*(NSS|nss)" .config || echo "æœªæ‰¾åˆ° NSS é…ç½®"
        
        echo ""
        echo "===== æ— çº¿é©±åŠ¨é…ç½® ====="
        grep -E "CONFIG_PACKAGE.*(mac80211|ath)" .config || echo "æœªæ‰¾åˆ°æ— çº¿é©±åŠ¨é…ç½®"
        
        echo ""
        echo "===== å…³é”®ä¾èµ–æ£€æŸ¥ ====="
        echo "æ£€æŸ¥å·²çŸ¥ç¼ºå¤±ä¾èµ–:"
        for dep in libev libpam libtirpc liblzma libnetsnmp; do
          if grep -q "CONFIG_PACKAGE_${dep}=y" .config; then
            echo "  âŒ ${dep}: å·²å¯ç”¨ä½†å¯èƒ½ç¼ºå¤±"
          fi
        done

    # 13. Download all sources
    - name: Download packages
      run: |
        cd "$OPENWRT_DIR"
        make download -j1 V=s

    # 14. Build firmware (å®‰å…¨æ–¹æ³• - ä¸éšè—é”™è¯¯)
    - name: Build firmware
      run: |
        cd "$OPENWRT_DIR"
        
        echo "å¼€å§‹æ„å»ºå›ºä»¶..."
        echo "æ³¨æ„: æ„å»ºè¿‡ç¨‹ä¸­ä¼šæœ‰è­¦å‘Šï¼Œä½†ä¸ä¼šéšè—é”™è¯¯"
        
        # æ–¹æ³•1: ç›´æ¥æ„å»ºï¼Œè¾“å‡ºå®Œæ•´æ—¥å¿—
        # ä½¿ç”¨ tee åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å’Œæ–‡ä»¶ï¼Œä½†ä¸è¿‡æ»¤é”™è¯¯
        build_log="$OPENWRT_DIR/build.log"
        
        echo "æ„å»ºæ—¥å¿—ä¿å­˜åˆ°: $build_log"
        
        # ä½¿ç”¨å‡½æ•°å¤„ç†æ„å»ºï¼Œç¡®ä¿é”™è¯¯ä¸ä¼šè¢«éšè—
        build_with_fallback() {
          local max_jobs=$(nproc)
          
          # å°è¯•å¹¶è¡Œæ„å»º
          echo "å°è¯•ä½¿ç”¨ $max_jobs ä¸ªä»»åŠ¡å¹¶è¡Œæ„å»º..."
          if make -j$max_jobs V=s 2>&1 | tee "$build_log"; then
            echo "âœ… å¹¶è¡Œæ„å»ºæˆåŠŸ"
            return 0
          else
            echo "âš ï¸ å¹¶è¡Œæ„å»ºå¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹æ„å»º..."
            if make -j1 V=s 2>&1 | tee -a "$build_log"; then
              echo "âœ… å•çº¿ç¨‹æ„å»ºæˆåŠŸ"
              return 0
            else
              echo "âŒ æ„å»ºå¤±è´¥"
              return 1
            fi
          fi
        }
        
        # æ‰§è¡Œæ„å»º
        if ! build_with_fallback; then
          echo ""
          echo "========================================="
          echo "æ„å»ºå¤±è´¥! å¯èƒ½çš„åŸå› :"
          echo "1. NSS é…ç½®å†²çª"
          echo "2. ç¼ºå¤±ä¾èµ–"
          echo "3. æºä»£ç ä¸‹è½½ä¸å®Œæ•´"
          echo ""
          echo "æŸ¥çœ‹æ„å»ºæ—¥å¿—çš„æœ€å50è¡Œ:"
          tail -50 "$build_log" || true
          exit 1
        fi
        
        echo ""
        echo "âœ… æ„å»ºå®Œæˆ!"

    # 15. æ£€æŸ¥å›ºä»¶ç”Ÿæˆæƒ…å†µ
    - name: Verify firmware files
      run: |
        echo "æ£€æŸ¥å›ºä»¶æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ..."
        firmware_dir="$OPENWRT_DIR/bin/targets/qualcommax/ipq807x"
        
        if [ ! -d "$firmware_dir" ]; then
          echo "âŒ å›ºä»¶ç›®å½•ä¸å­˜åœ¨: $firmware_dir"
          exit 1
        fi
        
        echo "âœ… å›ºä»¶ç›®å½•å­˜åœ¨"
        echo "æ–‡ä»¶åˆ—è¡¨:"
        ls -la "$firmware_dir/"
        
        echo ""
        echo "å…³é”®å›ºä»¶æ–‡ä»¶:"
        find "$firmware_dir" -name "*.bin" -o -name "*.ubi" -o -name "*.itb" 2>/dev/null | \
          while read file; do
            echo "  - $(basename "$file") ($(du -h "$file" | cut -f1))"
          done
        
        # æ£€æŸ¥æ˜¯å¦æœ‰è‡³å°‘ä¸€ä¸ªå›ºä»¶æ–‡ä»¶
        firmware_count=$(find "$firmware_dir" -name "*.bin" -o -name "*.ubi" -o -name "*.itb" 2>/dev/null | wc -l)
        if [ "$firmware_count" -eq 0 ]; then
          echo "âŒ æœªæ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶"
          exit 1
        fi
        
        echo "âœ… æ‰¾åˆ° $firmware_count ä¸ªå›ºä»¶æ–‡ä»¶"

    # 16. Upload build log (å¯é€‰)
    - name: Upload build log
      if: always()  # æ€»æ˜¯ä¸Šä¼ ï¼Œæ— è®ºæˆåŠŸå¤±è´¥
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: ${{ env.OPENWRT_DIR }}/build.log
        retention-days: 7

    # 17. Upload firmware
    - name: Upload firmware
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: Swaiot-CPE-S10-ipq807x-NSS
        path: ${{ env.OPENWRT_DIR }}/bin/targets/qualcommax/ipq807x/
        if-no-files-found: error
        retention-days: 30
        compression-level: 6

name: Check OpenWrt Config Packages

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  check-config:
    runs-on: ubuntu-latest
    env:
      OPENWRT_DIR: ${{ github.workspace }}/openwrt

    steps:
      # 1️⃣ 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ 确保 openwrt 目录存在
      - name: Ensure OpenWrt directory
        run: |
          mkdir -p "$OPENWRT_DIR"
      # 3️⃣ 拷贝 ci.config 生成 .config
      - name: Copy ci.config to .config
        run: |
          cp ci.config "$OPENWRT_DIR/.config"
          echo ".config copied to $OPENWRT_DIR"
      # 4️⃣ 检查 .config 是否存在
      - name: Ensure .config exists
        run: |
          if [ ! -f "$OPENWRT_DIR/.config" ]; then
            echo ".config not found in $OPENWRT_DIR"
            exit 1
          fi
      # 5️⃣ 提取已启用的 package 并统计
      - name: Extract enabled packages
        run: |
          echo "== Enabled packages in .config =="
          grep -E '^CONFIG_PACKAGE_' "$OPENWRT_DIR/.config" | grep -E '=y|=m' | sort > enabled_packages.txt
          cat enabled_packages.txt
          echo "Total enabled packages: $(wc -l < enabled_packages.txt)"
      # 6️⃣ 上传 artifact（保留 7 天）
      - name: Upload enabled package list
        uses: actions/upload-artifact@v4
        with:
          name: enabled-packages-list
          path: enabled_packages.txt
          retention-days: 7
      run: |
        echo "✅ DTS successfully compiled via kernel build"

name: Swaiot CPE-S10 (ipq807x NSS)

on:
  workflow_dispatch:
  push:
    branches:
      - swaiot-s10

env:
  TZ: Asia/Shanghai
  REPO_URL: https://github.com/Jim78778/immortalwrt.git
  REPO_BRANCH: main
  UPLOAD_FIRMWARE: true
  OPENWRT_DIR: /mnt/openwrt-build

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout workflow repo
      uses: actions/checkout@v4

    - name: Set timezone
      run: sudo timedatectl set-timezone "$TZ"

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt-get clean
        df -h

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex gawk gcc-multilib g++-multilib \
          gettext git libncurses-dev libssl-dev python3 \
          rsync unzip zlib1g-dev file wget bc time \
          libelf-dev device-tree-compiler

    - name: Prepare /mnt build directory
      run: |
        sudo mkdir -p "$OPENWRT_DIR"
        sudo chown $USER:$USER "$OPENWRT_DIR"

    - name: Clone source
      run: |
        git clone --depth=1 -b "$REPO_BRANCH" "$REPO_URL" "$OPENWRT_DIR"

    - name: Update & install feeds
      run: |
        cd "$OPENWRT_DIR"
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # üî• Áõ¥Êé•Áî®ÈªòËÆ§ÈÖçÁΩÆ
    - name: Load default config
      run: |
        cd "$OPENWRT_DIR"
        make defconfig

    - name: Download packages
      run: |
        cd "$OPENWRT_DIR"
        make download -j$(nproc)

    - name: Build firmware
      run: |
        cd "$OPENWRT_DIR"
        make -j$(nproc) V=s

    - name: Upload firmware
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: Swaiot-CPE-S10-ipq807x-NSS
        path: ${{ env.OPENWRT_DIR }}/bin/targets/qualcommax/ipq807x/
        if-no-files-found: error

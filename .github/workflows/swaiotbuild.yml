name: immortalwrt-ipq807x-s10

on:
  workflow_dispatch:
  push:
    branches:
      - swaiot-s10

env:
  TZ: Asia/Shanghai
  REPO_URL: https://github.com/Jim78778/immortalwrt.git
  REPO_BRANCH: main
  OPENWRT_DIR: openwrt
  UPLOAD_FIRMWARE: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    ##########################################################################
    # 1. 扩容磁盘
    ##########################################################################
    - name: 检查服务器配置
      run: |
        echo "若分配的服务器性能不足，务必及时取消，重新运行！"
        echo -e "------------------------------- CPU信息 -------------------------------\n"
        echo "CPU物理数量:$(cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l)"
        echo -e "CPU核心及版本信息: $(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
        echo -e "------------------------------- 内存信息 -------------------------------\n"
        echo "已安装内存详细信息: "
        sudo lshw -short -C memory | grep GiB
        echo -e "\n"
        echo -e "------------------------------- 磁盘信息 -------------------------------\n"
        echo -e "磁盘数量: $(ls /dev/sd* | grep -v [1-9] | wc -l) \n"
        echo "------------------------------- 磁盘详情 -------------------------------\n"
        df -Th
    ##########################################################################
    # 2. Checkout workflow 仓库
    ##########################################################################
    - name: Checkout
      uses: actions/checkout@v4

    ##########################################################################
    # 3. 初始化构建环境
    ##########################################################################
    - name: 初始化构建环境
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo timedatectl set-timezone "$TZ"
        sudo apt-get update
        sudo apt-get upgrade -y

        sudo apt-get install -y \
          build-essential clang cmake ninja-build flex bison gawk \
          gcc-multilib g++-multilib gettext git \
          python3 python3-pip python3-venv rsync unzip zlib1g-dev \
          wget curl patch jq ca-certificates ccache \
          libncurses5-dev libncursesw5-dev libssl-dev file \
          libelf-dev dwarves libzstd-dev libnuma-dev \
          libunwind-dev libbpf-dev libdebuginfod-dev liblzma-dev \
          libcurl4-openssl-dev libnl-3-dev libnl-genl-3-dev libnl-route-3-dev \
          libpcap-dev libusb-1.0-0-dev iptables iproute2 net-tools ethtool bridge-utils \
          asciidoc xmlto python3-docutils

        sudo ccache --max-size=10G
        sudo ccache --set-config=sloppiness=file_macro,locale,time_macros

    - name: 设置 ccache 环境变量
      run: |
        echo "USE_CCACHE=1" >> $GITHUB_ENV
        echo "CCACHE_DIR=/tmp/ccache" >> $GITHUB_ENV

    - name: 设置 ccache 缓存
      uses: actions/cache@v3
      with:
        path: /tmp/ccache
        key: ${{ runner.os }}-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    ##########################################################################
    # 4. 克隆 ImmortalWrt
    ##########################################################################
    - name: 克隆 ImmortalWrt
      run: |
        git clone --depth=1 -b "$REPO_BRANCH" "$REPO_URL" "$OPENWRT_DIR"

    ##########################################################################
    # 5. OpenWrt 构建缓存
    ##########################################################################
    - name: 缓存构建
      uses: klever1988/cachewrtbuild@main
      with:
        ccache: true
        prefix: ${{ github.workspace }}/openwrt
        mixkey: ipq807x-s10-${{ env.REPO_BRANCH }}

    ##########################################################################
    # 6. 更新 feeds
    ##########################################################################
    - name: 更新 feeds
      run: |
        cd "$OPENWRT_DIR"
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        ./scripts/feeds install -a -f -p qmodem

    ##########################################################################
    # 7. 放入 .config 并 defconfig
    ##########################################################################
    - name: 配置 .config
      run: |
        cd "$OPENWRT_DIR"
        if [ -f "${{ github.workspace }}/.config" ]; then
          cp "${{ github.workspace }}/.config" .config
          echo ">>> Using provided .config"
        fi
        make defconfig

    ##########################################################################
    # 8. 强制移除 qca-nss-ecm（关键）
    ##########################################################################
    - name: Remove qca-nss-ecm (force)
      run: |
        cd "$OPENWRT_DIR"

        echo ">>> Force removing qca-nss-ecm"
        rm -rf feeds/nss_packages/qca-nss-ecm || true
        rm -rf package/feeds/nss_packages/qca-nss-ecm || true

        sed -i '/qca-nss-ecm/d' .config || true
        sed -i '/NSS_ECM/d' .config || true
        make defconfig
        yes "" | make kernel_oldconfig

    ##########################################################################
    # 9. 下载源码
    ##########################################################################
    - name: 下载源码
      run: |
        cd "$OPENWRT_DIR"
        make download -j$(nproc)
        find dl -size -1024c -delete

    ##########################################################################
    # 10. 编译固件
    ##########################################################################
    - name: 编译固件
      run: |
        cd "$OPENWRT_DIR"
        make -j$(nproc) V=sc

    ##########################################################################
    # 11. 上传固件
    ##########################################################################
    - name: 上传固件
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-ipq807x-s10
        path: openwrt/bin/targets
        retention-days: 30

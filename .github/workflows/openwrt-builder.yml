name: Build ImmortalWrt-IPQ with QModem

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  # ===== æºç  =====
  REPO_URL: https://github.com/Jim78778/immortalwrt-ipq.git
  REPO_BRANCH: main

  # ===== é…ç½® =====
  CONFIG_FILE: .config
  FEEDS_CONF: feeds.conf.default

  # ===== æ—¶åŒº =====
  TZ: Asia/Shanghai

  # ===== è¾“å‡ºæ§åˆ¶ =====
  UPLOAD_FIRMWARE: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout AutoBuild Repo
      uses: actions/checkout@v4

    - name: Set Timezone
      run: |
        sudo timedatectl set-timezone "$TZ"

    - name: Initialize Build Environment
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex g++ gawk gcc-multilib gettext \
          git libncurses5-dev libssl-dev python3 python3-distutils \
          rsync unzip zlib1g-dev file wget \
          libelf-dev ecj fastjar

    - name: Clone ImmortalWrt-IPQ Source
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        git log -1 --oneline

    # ===== æ·»åŠ  QModem feed =====
    - name: Add QModem Feed
      run: |
        cd openwrt
        echo "src-git qmodem https://github.com/FUjr/QModem.git" >> $FEEDS_CONF
        tail -n 5 $FEEDS_CONF

    - name: Update & Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # ===== è½½å…¥é…ç½® & å¼ºåˆ¶ç¦ç”¨ Rust =====
    - name: Load .config
      run: |
        cd openwrt
        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "âŒ æœªæ‰¾åˆ° .config"
          exit 1
        fi

        cp $GITHUB_WORKSPACE/$CONFIG_FILE .config

        # ğŸš« å¼ºåˆ¶ç¦ç”¨ Rustï¼ˆé¿å… host rustc ç¼–è¯‘ï¼‰
        sed -i 's/CONFIG_RUST=y/# CONFIG_RUST is not set/' .config
        sed -i 's/CONFIG_RUST_TOOLCHAIN=y/# CONFIG_RUST_TOOLCHAIN is not set/' .config

        yes "" | make oldconfig

        echo "==== RUST CHECK ===="
        grep -i rust .config || echo "OK: no rust enabled"

    - name: Download Packages
      run: |
        cd openwrt
        make download -j$(nproc)

    - name: Compile Firmware
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s

    - name: Upload Firmware
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ImmortalWrt-IPQ-QModem
        path: |
          openwrt/bin/targets/*/*

name: Build ImmortalWrt-IPQ with QModem

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  # ===== 源码 =====
  REPO_URL: https://github.com/Jim78778/immortalwrt-ipq.git
  REPO_BRANCH: main

  # ===== 配置 =====
  CONFIG_FILE: .config
  FEEDS_CONF: feeds.conf.default

  # ===== 时区 =====
  TZ: Asia/Shanghai

  # ===== 输出 =====
  UPLOAD_FIRMWARE: true
  UPLOAD_BIN_DIR: false
  UPLOAD_RELEASE: false

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout AutoBuild Repo
      uses: actions/checkout@v4

    - name: Initialize Build Environment
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex g++ gawk gcc-multilib gettext \
          git libncurses5-dev libssl-dev python3 python3-distutils \
          rsync unzip zlib1g-dev file wget

    - name: Clone ImmortalWrt-IPQ Source
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        git log -1 --oneline

    # ======= 关键：添加 QModem feed =======
    - name: Add QModem Feed
      run: |
        cd openwrt
        echo "src-git qmodem https://github.com/FUjr/QModem.git" >> feeds.conf.default
        tail -n 5 feeds.conf.default

    - name: Update & Install Feeds (with QModem)
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        ./scripts/feeds install -a -p qmodem

    - name: Load .config
      run: |
        cd openwrt
        if [ ! -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
          echo "❌ 未找到 .config"
          exit 1
        fi
        cp $GITHUB_WORKSPACE/$CONFIG_FILE .config
        yes "" | make oldconfig

    - name: Download Packages
      run: |
        cd openwrt
        make download -j8

    - name: Compile Firmware
      run: |
        cd openwrt
        make -j$(nproc) V=s || make -j1 V=s

    - name: Upload Firmware
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ImmortalWrt-IPQ-QModem
        path: openwrt/bin/targets/
